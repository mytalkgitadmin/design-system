name: Sync GitHub Issue Status to Jira

on:
  issues:
    types: [labeled, unlabeled, closed, reopened]

jobs:
  sync-to-jira:
    name: Sync Issue Status to Jira
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. GitHub Issueì—ì„œ Jira í‹°ì¼“ ë²ˆí˜¸ ì¶”ì¶œ
      - name: Extract Jira ticket from issue
        id: extract-ticket
        run: |
          # ì œëª©ì—ì„œ [JIRA-123] í˜•ì‹ìœ¼ë¡œ ì¶”ì¶œ
          JIRA_TICKET=$(echo '${{ github.event.issue.title }}' | grep -oE '\[([A-Z]+-[0-9]+)\]' | tr -d '[]' | head -n 1)

          # ì œëª©ì— ì—†ìœ¼ë©´ ë³¸ë¬¸ì—ì„œ ì¶”ì¶œ
          if [ -z "$JIRA_TICKET" ]; then
            JIRA_TICKET=$(echo '${{ github.event.issue.body }}' | grep -oE '([A-Z]+-[0-9]+)' | head -n 1)
          fi

          if [ -z "$JIRA_TICKET" ]; then
            echo "âš ï¸  Jira í‹°ì¼“ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë™ê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "jira_ticket=$JIRA_TICKET" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "âœ… Jira í‹°ì¼“ ë°œê²¬: $JIRA_TICKET"

      # 3. Workflow config íŒŒì¼ ë¡œë“œ
      - name: Load Jira workflow config
        if: steps.extract-ticket.outputs.skip != 'true'
        id: load-config
        run: |
          if [ ! -f "scripts/jira/jira-workflow-config.json" ]; then
            echo "âš ï¸  jira-workflow-config.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "ğŸ’¡ ë¨¼ì € 'Setup Jira Workflow' ì•¡ì…˜ì„ ì‹¤í–‰í•˜ì„¸ìš”."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âœ… Workflow config ë¡œë“œ ì™„ë£Œ"
          cat scripts/jira/jira-workflow-config.json | jq '.'
          echo "skip=false" >> $GITHUB_OUTPUT

      # 4. GitHub Issue ìƒíƒœë¥¼ Jira transition IDë¡œ ë§¤í•‘
      - name: Map GitHub status to Jira transition
        if: steps.extract-ticket.outputs.skip != 'true' && steps.load-config.outputs.skip != 'true'
        id: map-status
        run: |
          LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
          IS_CLOSED="${{ github.event.issue.state == 'closed' }}"

          echo "í˜„ì¬ ë¼ë²¨: ${LABELS}"
          echo "ì´ìŠˆ ìƒíƒœ: ${{ github.event.issue.state }}"
          echo ""

          # Config íŒŒì¼ì—ì„œ transition ID ì½ê¸°
          CONFIG_FILE="scripts/jira/jira-workflow-config.json"
          START_ID=$(jq -r '.mappings.start // empty' "$CONFIG_FILE")
          END_ID=$(jq -r '.mappings.end // empty' "$CONFIG_FILE")
          REVIEW_ID=$(jq -r '.mappings.review // empty' "$CONFIG_FILE")
          BLOCKED_ID=$(jq -r '.mappings.blocked // empty' "$CONFIG_FILE")

          echo "ğŸ“‹ ì„¤ì •ëœ Transition ID:"
          echo "  Start (in progress): $START_ID"
          echo "  End (done): $END_ID"
          echo "  Review: $REVIEW_ID"
          echo "  Blocked: $BLOCKED_ID"
          echo ""

          # ë¼ë²¨ì— ë”°ë¼ transition ID ì„ íƒ
          TRANSITION_ID=""
          COMMENT=""

          if [ "$IS_CLOSED" = "true" ]; then
            TRANSITION_ID="$END_ID"
            COMMENT="âœ… ì‘ì—… ì™„ë£Œ (GitHub Issueê°€ ë‹«í˜”ìŠµë‹ˆë‹¤)"
          elif echo "$LABELS" | grep -q "in progress"; then
            TRANSITION_ID="$START_ID"
            COMMENT="ğŸš€ ì‘ì—… ì§„í–‰ ì¤‘"
          elif echo "$LABELS" | grep -q "review"; then
            TRANSITION_ID="$REVIEW_ID"
            COMMENT="ğŸ‘€ ë¦¬ë·° ì¤‘"
          elif echo "$LABELS" | grep -q "blocked"; then
            TRANSITION_ID="$BLOCKED_ID"
            COMMENT="ğŸš§ ì‘ì—… ë¸”ë¡œí‚¹ë¨"
          else
            echo "âš ï¸  ë§¤í•‘í•  ë¼ë²¨ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "skip_update=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Transition IDê°€ nullì´ê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´ ìŠ¤í‚µ
          if [ -z "$TRANSITION_ID" ] || [ "$TRANSITION_ID" = "null" ]; then
            echo "âš ï¸  í•´ë‹¹ ìƒíƒœì— ëŒ€í•œ transition IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "ğŸ’¡ 'Setup Jira Workflow'ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”."
            echo "skip_update=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "transition_id=${TRANSITION_ID}" >> $GITHUB_OUTPUT
          echo "comment=${COMMENT}" >> $GITHUB_OUTPUT
          echo "skip_update=false" >> $GITHUB_OUTPUT
          echo "âœ… ì‚¬ìš©í•  Transition ID: ${TRANSITION_ID}"

      # 5. ì‘ì—…ì í• ë‹¹
      - name: Assign to current user
        if: steps.map-status.outputs.skip_update != 'true' && steps.extract-ticket.outputs.skip != 'true' && steps.load-config.outputs.skip != 'true'
        run: |
          JIRA_TICKET="${{ steps.extract-ticket.outputs.jira_ticket }}"

          echo "ğŸ‘¤ ì‘ì—…ì í• ë‹¹ ì¤‘..."

          # í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          MYSELF=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/myself")

          ACCOUNT_ID=$(echo "$MYSELF" | jq -r '.accountId')
          DISPLAY_NAME=$(echo "$MYSELF" | jq -r '.displayName')

          echo "  ì‚¬ìš©ì: $DISPLAY_NAME (ID: $ACCOUNT_ID)"

          # ì‘ì—…ì í• ë‹¹
          ASSIGN_RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{\"accountId\": \"${ACCOUNT_ID}\"}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/assignee")

          HTTP_CODE=$(echo "$ASSIGN_RESPONSE" | tail -n1)

          if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… ì‘ì—…ì í• ë‹¹ ì™„ë£Œ"
          else
            echo "âš ï¸  ì‘ì—…ì í• ë‹¹ ì‹¤íŒ¨ (HTTP $HTTP_CODE) - ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤"
          fi
          echo ""

      # 6. Jira ìƒíƒœ ì—…ë°ì´íŠ¸ (ë‹¨ìˆœ ID ê¸°ë°˜)
      - name: Update Jira status
        if: steps.map-status.outputs.skip_update != 'true' && steps.extract-ticket.outputs.skip != 'true' && steps.load-config.outputs.skip != 'true'
        id: update-status
        run: |
          JIRA_TICKET="${{ steps.extract-ticket.outputs.jira_ticket }}"
          TRANSITION_ID="${{ steps.map-status.outputs.transition_id }}"

          echo "ğŸ”„ Jira ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘..."
          echo "  Ticket: $JIRA_TICKET"
          echo "  Transition ID: $TRANSITION_ID"

          # Transition ì‹¤í–‰
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{\"transition\": {\"id\": \"${TRANSITION_ID}\"}}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/transitions"

          echo "âœ… ìƒíƒœ ë³€ê²½ ì™„ë£Œ"
          echo "success=true" >> $GITHUB_OUTPUT

      # 7. Jiraì— ì½”ë©˜íŠ¸ ì¶”ê°€
      - name: Add comment to Jira
        if: steps.extract-ticket.outputs.skip != 'true' && steps.map-status.outputs.skip_update != 'true'
        run: |
          JIRA_TICKET="${{ steps.extract-ticket.outputs.jira_ticket }}"
          COMMENT="${{ steps.map-status.outputs.comment }}"
          GITHUB_URL="${{ github.event.issue.html_url }}"
          ACTOR="${{ github.actor }}"

          COMMENT_BODY="${COMMENT}\n\nğŸ“Œ By: ${ACTOR}\nğŸ”— GitHub Issue: ${GITHUB_URL}"

          curl -X POST \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{\"body\": \"${COMMENT_BODY}\"}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/comment"

          echo "âœ… Jira ì½”ë©˜íŠ¸ ì¶”ê°€ ì™„ë£Œ"

      # 8. ì‹¤ì œ Jira ìƒíƒœ ì¡°íšŒ
      - name: Get current Jira status
        if: steps.extract-ticket.outputs.skip != 'true'
        id: get-status
        run: |
          JIRA_TICKET="${{ steps.extract-ticket.outputs.jira_ticket }}"
          UPDATE_SUCCESS="${{ steps.update-status.outputs.success }}"

          echo "ğŸ” Jira í˜„ì¬ ìƒíƒœ ì¡°íšŒ ì¤‘..."
          ISSUE_INFO=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}")

          CURRENT_STATUS=$(echo "$ISSUE_INFO" | jq -r '.fields.status.name')

          # ìƒíƒœ ë©”ì‹œì§€ ê²°ì •
          if [ "$UPDATE_SUCCESS" = "true" ]; then
            STATUS_MESSAGE="âœ… ìƒíƒœ ë³€ê²½ë¨"
          else
            STATUS_MESSAGE="â„¹ï¸  í˜„ì¬ ìƒíƒœ"
          fi

          echo "status=${CURRENT_STATUS}" >> $GITHUB_OUTPUT
          echo "status_message=${STATUS_MESSAGE}" >> $GITHUB_OUTPUT
          echo "âœ… ì¡°íšŒëœ ìƒíƒœ: ${CURRENT_STATUS}"

      # 9. GitHub Issueì— ë™ê¸°í™” ì™„ë£Œ ì½”ë©˜íŠ¸
      - name: Comment sync result on GitHub
        if: steps.extract-ticket.outputs.skip != 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## ğŸ”„ Jira ìƒíƒœ ë™ê¸°í™”

            > ${{ steps.map-status.outputs.comment }}

            | | |
            |:---|:---|
            | ğŸ« **Jira Ticket** | [${{ steps.extract-ticket.outputs.jira_ticket }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.extract-ticket.outputs.jira_ticket }}) |
            | ğŸ“Š **í˜„ì¬ ìƒíƒœ** | **${{ steps.get-status.outputs.status }}** ${{ steps.get-status.outputs.status_message }} |
            | ğŸ‘¤ **ë‹´ë‹¹ì** | @${{ github.actor }} |
