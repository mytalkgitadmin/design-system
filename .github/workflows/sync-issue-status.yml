name: Sync GitHub Issue Status to Jira

on:
  issues:
    types: [labeled, unlabeled, closed, reopened]

jobs:
  sync-to-jira:
    name: Sync Issue Status to Jira
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. GitHub Issueì—ì„œ Jira í‹°ì¼“ ë²ˆí˜¸ ì¶”ì¶œ
      - name: Extract Jira ticket from issue
        id: extract-ticket
        run: |
          TITLE="${{ github.event.issue.title }}"
          BODY="${{ github.event.issue.body }}"
          
          # ì œëª©ì—ì„œ [JIRA-123] í˜•ì‹ìœ¼ë¡œ ì¶”ì¶œ
          JIRA_TICKET=$(echo "$TITLE" | grep -oE '\[([A-Z]+-[0-9]+)\]' | tr -d '[]' | head -n 1)
          
          # ì œëª©ì— ì—†ìœ¼ë©´ ë³¸ë¬¸ì—ì„œ ì¶”ì¶œ
          if [ -z "$JIRA_TICKET" ]; then
            JIRA_TICKET=$(echo "$BODY" | grep -oE '([A-Z]+-[0-9]+)' | head -n 1)
          fi
          
          if [ -z "$JIRA_TICKET" ]; then
            echo "âš ï¸  Jira í‹°ì¼“ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë™ê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "jira_ticket=${JIRA_TICKET}" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "âœ… Jira í‹°ì¼“ ë°œê²¬: ${JIRA_TICKET}"

      # 3. GitHub Issue ìƒíƒœë¥¼ Jira ìƒíƒœë¡œ ë§¤í•‘
      - name: Map GitHub status to Jira
        if: steps.extract-ticket.outputs.skip != 'true'
        id: map-status
        run: |
          LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
          IS_CLOSED="${{ github.event.issue.state == 'closed' }}"
          
          echo "í˜„ì¬ ë¼ë²¨: ${LABELS}"
          echo "ì´ìŠˆ ìƒíƒœ: ${{ github.event.issue.state }}"
          
          # ìƒíƒœ ë§¤í•‘ ë¡œì§
          if [ "$IS_CLOSED" = "true" ]; then
            JIRA_STATUS="Done"
            COMMENT="âœ… ì‘ì—… ì™„ë£Œ (GitHub Issueê°€ ë‹«í˜”ìŠµë‹ˆë‹¤)"
          elif echo "$LABELS" | grep -q "in progress"; then
            JIRA_STATUS="In Progress"
            COMMENT="ğŸš€ ì‘ì—… ì‹œì‘"
          elif echo "$LABELS" | grep -q "review"; then
            JIRA_STATUS="In Review"
            COMMENT="ğŸ‘€ ë¦¬ë·° ì¤‘"
          elif echo "$LABELS" | grep -q "blocked"; then
            JIRA_STATUS="Blocked"
            COMMENT="ğŸš§ ì‘ì—… ë¸”ë¡œí‚¹ë¨"
          else
            echo "âš ï¸  ë§¤í•‘í•  Jira ìƒíƒœê°€ ì—†ìŠµë‹ˆë‹¤."
            echo "skip_update=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "jira_status=${JIRA_STATUS}" >> $GITHUB_OUTPUT
          echo "comment=${COMMENT}" >> $GITHUB_OUTPUT
          echo "skip_update=false" >> $GITHUB_OUTPUT
          echo "âœ… Jira ìƒíƒœë¡œ ë§¤í•‘: ${JIRA_STATUS}"

      # 4. Jira API - ì‚¬ìš© ê°€ëŠ¥í•œ transition ì¡°íšŒ
      - name: Get available Jira transitions
        if: steps.map-status.outputs.skip_update != 'true' && steps.extract-ticket.outputs.skip != 'true'
        id: get-transitions
        run: |
          JIRA_TICKET="${{ steps.extract-ticket.outputs.jira_ticket }}"
          TARGET_STATUS="${{ steps.map-status.outputs.jira_status }}"
          
          echo "ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ transition ì¡°íšŒ ì¤‘..."
          
          RESPONSE=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/transitions")
          
          echo "$RESPONSE" | jq -r '.transitions[] | "\(.id): \(.name) â†’ \(.to.name)"'
          
          # ëª©í‘œ ìƒíƒœë¡œ ê°€ëŠ” transition ID ì°¾ê¸°
          TRANSITION_ID=$(echo "$RESPONSE" | jq -r ".transitions[] | select(.to.name == \"${TARGET_STATUS}\" or .name == \"${TARGET_STATUS}\") | .id" | head -n 1)
          
          if [ -z "$TRANSITION_ID" ] || [ "$TRANSITION_ID" = "null" ]; then
            echo "âš ï¸  '${TARGET_STATUS}'ë¡œ ê°€ëŠ” transitionì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "skip_transition=true" >> $GITHUB_OUTPUT
          else
            echo "transition_id=${TRANSITION_ID}" >> $GITHUB_OUTPUT
            echo "skip_transition=false" >> $GITHUB_OUTPUT
            echo "âœ… Transition ID ë°œê²¬: ${TRANSITION_ID}"
          fi

      # 5. Jira ìƒíƒœ ì—…ë°ì´íŠ¸
      - name: Update Jira status
        if: steps.get-transitions.outputs.skip_transition != 'true' && steps.map-status.outputs.skip_update != 'true' && steps.extract-ticket.outputs.skip != 'true'
        run: |
          JIRA_TICKET="${{ steps.extract-ticket.outputs.jira_ticket }}"
          TRANSITION_ID="${{ steps.get-transitions.outputs.transition_id }}"
          
          echo "ğŸ”„ Jira ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘..."
          
          curl -X POST \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{\"transition\": {\"id\": \"${TRANSITION_ID}\"}}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/transitions"
          
          echo "âœ… Jira ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${{ steps.map-status.outputs.jira_status }}"

      # 6. Jiraì— ì½”ë©˜íŠ¸ ì¶”ê°€
      - name: Add comment to Jira
        if: steps.extract-ticket.outputs.skip != 'true' && steps.map-status.outputs.skip_update != 'true'
        run: |
          JIRA_TICKET="${{ steps.extract-ticket.outputs.jira_ticket }}"
          COMMENT="${{ steps.map-status.outputs.comment }}"
          GITHUB_URL="${{ github.event.issue.html_url }}"
          ACTOR="${{ github.actor }}"
          
          COMMENT_BODY="${COMMENT}\n\nğŸ“Œ By: ${ACTOR}\nğŸ”— GitHub Issue: ${GITHUB_URL}"
          
          curl -X POST \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{\"body\": \"${COMMENT_BODY}\"}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/comment"
          
          echo "âœ… Jira ì½”ë©˜íŠ¸ ì¶”ê°€ ì™„ë£Œ"

      # 7. GitHub Issueì— ë™ê¸°í™” ì™„ë£Œ ì½”ë©˜íŠ¸
      - name: Comment sync result on GitHub
        if: steps.extract-ticket.outputs.skip != 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## ğŸ”„ Jira ë™ê¸°í™” ì™„ë£Œ
            
            **Jira Ticket:** [${{ steps.extract-ticket.outputs.jira_ticket }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.extract-ticket.outputs.jira_ticket }})
            **ìƒíƒœ:** ${{ steps.map-status.outputs.jira_status }}
            **ë©”ì‹œì§€:** ${{ steps.map-status.outputs.comment }}
            
            _ìë™ìœ¼ë¡œ Jira ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤._

