name: Create Jira Issue

on:
  issues:
    types: [opened]

jobs:
  create-jira-issue:
    name: Create Jira Issue and Branch
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      # 2. .env íŒŒì¼ ë¡œë“œ í™•ì¸
      - name: Check .env file
        run: |
          if [ ! -f .env ]; then
            echo "âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
            echo "ğŸ“ .env.exampleì„ ì°¸ê³ í•˜ì—¬ .env íŒŒì¼ì„ ìƒì„±í•˜ê³  ì»¤ë°‹í•´ì£¼ì„¸ìš”."
            exit 1
          fi

          echo "âœ… .env íŒŒì¼ í™•ì¸ ì™„ë£Œ"

          # í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ì²´í¬
          source .env
          if [ -z "$JIRA_BASE_URL" ] || [ -z "$JIRA_USER_EMAIL" ] || [ -z "$JIRA_API_TOKEN" ]; then
            echo "âŒ .env íŒŒì¼ì— í•„ìˆ˜ ê°’ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤!"
            exit 1
          fi

      # 3. ì´ìŠˆ íŒŒì‹± (ë§ˆí¬ë‹¤ìš´ì—ì„œ ì§ì ‘ ì¶”ì¶œ)
      - name: Parse GitHub Issue
        id: issue-parser
        run: |
          BODY="${{ github.event.issue.body }}"

          # parentKey ì¶”ì¶œ (### ğŸŸï¸ ìƒìœ„ ì‘ì—… ë‹¤ìŒ ì¤„)
          PARENT_KEY=$(echo "$BODY" | sed -n '/### ğŸŸï¸ ìƒìœ„ ì‘ì—…/,/###/p' | sed '1d;$d' | xargs)
          echo "issueparser_parentKey=${PARENT_KEY}" >> $GITHUB_OUTPUT

          # branch ì¶”ì¶œ (### ğŸŒ³ ë¸Œëœì¹˜ëª… ë‹¤ìŒ ì¤„)
          BRANCH=$(echo "$BODY" | sed -n '/### ğŸŒ³ ë¸Œëœì¹˜ëª…/,/###/p' | sed '1d;$d' | xargs)
          echo "issueparser_branch=${BRANCH}" >> $GITHUB_OUTPUT

          echo "âœ… Parsed - Parent: ${PARENT_KEY}, Branch: ${BRANCH}"

      # 4. ë§ˆí¬ë‹¤ìš´ì„ Jira ë¬¸ë²•ìœ¼ë¡œ ë³€í™˜
      - name: Convert markdown to Jira syntax
        uses: peter-evans/jira2md@v1
        id: md2jira
        with:
          input-text: |
            h3. GitHub Issue Link
            * ${{ github.event.issue.html_url }}

            ${{ github.event.issue.body }}
          mode: md2jira

      # 5. Jira í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
      - name: Load Jira credentials
        id: jira-env
        run: |
          source .env
          echo "JIRA_BASE_URL=${JIRA_BASE_URL}" >> $GITHUB_ENV
          echo "JIRA_USER_EMAIL=${JIRA_USER_EMAIL}" >> $GITHUB_ENV
          echo "JIRA_API_TOKEN=${JIRA_API_TOKEN}" >> $GITHUB_ENV
          echo "JIRA_PROJECT=${JIRA_PROJECT:-FMTW}" >> $GITHUB_ENV

      # 6. Jira ë¡œê·¸ì¸
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ env.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ env.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ env.JIRA_USER_EMAIL }}

      # 7. Jira ì´ìŠˆ ìƒì„± (parent ì—†ì´)
      - name: Create Jira Issue
        id: create-jira
        uses: atlassian/gajira-create@v3
        with:
          project: ${{ env.JIRA_PROJECT }}
          issuetype: Task
          summary: "${{ github.event.issue.title }}"
          description: "${{ steps.md2jira.outputs.output-text }}"

      # 8. Parent í‹°ì¼“ ì—°ê²° (ì„ íƒì‚¬í•­)
      - name: Link to parent issue
        if: steps.issue-parser.outputs.issueparser_parentKey != ''
        continue-on-error: true
        run: |
          source .env
          PARENT_KEY="${{ steps.issue-parser.outputs.issueparser_parentKey }}"
          ISSUE_KEY="${{ steps.create-jira.outputs.issue }}"

          if [ -n "$PARENT_KEY" ] && [ "$PARENT_KEY" != "null" ]; then
            echo "ğŸ”— Linking to parent: $PARENT_KEY"
            
            # Jira REST APIë¡œ parent ì„¤ì •
            RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
              -H "Content-Type: application/json" \
              -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
              -d "{\"fields\":{\"parent\":{\"key\":\"${PARENT_KEY}\"}}}" \
              "${JIRA_BASE_URL}/rest/api/2/issue/${ISSUE_KEY}")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
            if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Successfully linked to parent: $PARENT_KEY"
            else
              echo "âš ï¸  Failed to link parent (HTTP $HTTP_CODE). Task created without parent."
            fi
          fi

      # 9. ìƒì„±ëœ Jira ì´ìŠˆ ì •ë³´ ë¡œê·¸
      - name: Log created Jira issue
        run: |
          source .env
          echo "âœ… Jira Issue Created: ${{ steps.create-jira.outputs.issue }}"
          echo "ğŸ”— Issue URL: ${JIRA_BASE_URL}/browse/${{ steps.create-jira.outputs.issue }}"

      # 10. develop ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          token: ${{ secrets.GITHUB_TOKEN }}

      # 11. Git ì„¤ì •
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 12. ë¸Œëœì¹˜ ìƒì„± ë° í‘¸ì‹œ
      - name: Create and push branch
        id: create-branch
        run: |
          ISSUE_NUMBER="${{ steps.create-jira.outputs.issue }}"
          BRANCH_NAME_RAW="${{ steps.issue-parser.outputs.issueparser_branch }}"

          # ë¸Œëœì¹˜ëª… ì •ì œ (ê³µë°±ì„ í•˜ì´í”ˆìœ¼ë¡œ, íŠ¹ìˆ˜ë¬¸ì ì œê±°)
          BRANCH_NAME_CLEAN=$(echo "${BRANCH_NAME_RAW}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/-\+/-/g' | sed 's/^-//;s/-$//')

          # ìµœì¢… ë¸Œëœì¹˜ëª…
          BRANCH_NAME="${ISSUE_NUMBER}-${BRANCH_NAME_CLEAN}"

          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

          git checkout -b "${BRANCH_NAME}"
          git push origin "${BRANCH_NAME}"

          echo "âœ… Branch created: ${BRANCH_NAME}"

      # 13. Jiraì— ë¸Œëœì¹˜ ë§í¬ ì½”ë©˜íŠ¸ ì¶”ê°€
      - name: Add branch link to Jira
        run: |
          source .env
          BRANCH_NAME="${{ steps.create-branch.outputs.branch_name }}"
          ISSUE_NUMBER="${{ steps.create-jira.outputs.issue }}"
          BRANCH_URL="${{ github.server_url }}/${{ github.repository }}/tree/${BRANCH_NAME}"

          curl -X POST \
            -H "Content-Type: application/json" \
            -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            -d "{\"body\": \"ğŸŒ¿ Branch created: [${BRANCH_NAME}|${BRANCH_URL}]\"}" \
            "${JIRA_BASE_URL}/rest/api/2/issue/${ISSUE_NUMBER}/comment"

      # 14. GitHub ì´ìŠˆ ì œëª© ì—…ë°ì´íŠ¸
      - name: Update GitHub issue title
        uses: actions-cool/issues-helper@v3
        with:
          actions: "update-issue"
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "[${{ steps.create-jira.outputs.issue }}] ${{ github.event.issue.title }}"

      # 15. GitHub ì´ìŠˆ ë³¸ë¬¸ì„ í…œí”Œë¦¿ í˜•ì‹ìœ¼ë¡œ ì—…ë°ì´íŠ¸
      - name: Update GitHub issue body
        uses: actions-cool/issues-helper@v3
        with:
          actions: "update-issue"
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ## ğŸ“‹ ì´ìŠˆ ì •ë³´

            **Jira Ticket:** [${{ steps.create-jira.outputs.issue }}](${{ env.JIRA_BASE_URL }}/browse/${{ steps.create-jira.outputs.issue }})
            **Branch:** `${{ steps.create-branch.outputs.branch_name }}`
            **Parent Ticket:** `${{ steps.issue-parser.outputs.issueparser_parentKey }}`

            ---

            ${{ github.event.issue.body }}

      # 16. GitHub ì´ìŠˆì— Jira ë§í¬ ì½”ë©˜íŠ¸ ì¶”ê°€
      - name: Add Jira link to GitHub issue
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## âœ… Jira Issue Created

            **Jira Ticket:** [${{ steps.create-jira.outputs.issue }}](${{ env.JIRA_BASE_URL }}/browse/${{ steps.create-jira.outputs.issue }})
            **Branch:** `${{ steps.create-branch.outputs.branch_name }}`
            **Parent:** ${{ steps.issue-parser.outputs.issueparser_parentKey }}

            ### ğŸš€ Next Steps
            ```bash
            git fetch origin
            git checkout -b ${{ steps.create-branch.outputs.branch_name }} origin/${{ steps.create-branch.outputs.branch_name }}
            ```

      # 17. ì—ëŸ¬ ì²˜ë¦¬ - ì‹¤íŒ¨ ì‹œ GitHub ì´ìŠˆì— ì½”ë©˜íŠ¸
      - name: Comment on failure
        if: failure()
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## âŒ Jira Issue Creation Failed

            ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒì„ í™•ì¸í•´ì£¼ì„¸ìš”:

            1. **.env íŒŒì¼ í™•ì¸**
               - `.env` íŒŒì¼ì´ ë ˆí¬ì§€í† ë¦¬ì— ì»¤ë°‹ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
               - í•„ìˆ˜ ê°’ë“¤ì´ ëª¨ë‘ ì…ë ¥ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
               - `JIRA_BASE_URL`, `JIRA_USER_EMAIL`, `JIRA_API_TOKEN`, `JIRA_PROJECT`

            2. **Jira ê¶Œí•œ í™•ì¸**
               - API í† í°ì´ ìœ íš¨í•œì§€
               - í”„ë¡œì íŠ¸ ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ”ì§€

            3. **ì›Œí¬í”Œë¡œìš° ë¡œê·¸ í™•ì¸**
               - [Actions íƒ­](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})ì—ì„œ ìƒì„¸ ë¡œê·¸ í™•ì¸
