name: Create Jira Issue

on:
  issues:
    types: [opened]

jobs:
  create-jira-issue:
    name: Create Jira Issue and Branch
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ (ì´ìŠˆ í…œí”Œë¦¿ íŒŒì‹±ìš©)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      # 2. ì´ìŠˆ íŒŒì‹± (ë§ˆí¬ë‹¤ìš´ì—ì„œ ì§ì ‘ ì¶”ì¶œ)
      - name: Parse GitHub Issue
        id: issue-parser
        run: |
          BODY="${{ github.event.issue.body }}"
          
          # parentKey ì¶”ì¶œ
          PARENT_KEY=$(echo "$BODY" | grep -A 1 "ğŸŸï¸ ìƒìœ„ ì‘ì—…" | tail -n 1 | xargs)
          echo "issueparser_parentKey=${PARENT_KEY}" >> $GITHUB_OUTPUT
          
          # branch ì¶”ì¶œ
          BRANCH=$(echo "$BODY" | grep -A 1 "ğŸŒ³ ë¸Œëœì¹˜ëª…" | tail -n 1 | xargs)
          echo "issueparser_branch=${BRANCH}" >> $GITHUB_OUTPUT
          
          echo "âœ… Parsed - Parent: ${PARENT_KEY}, Branch: ${BRANCH}"

      # 3. ë§ˆí¬ë‹¤ìš´ì„ Jira ë¬¸ë²•ìœ¼ë¡œ ë³€í™˜
      - name: Convert markdown to Jira syntax
        uses: peter-evans/jira2md@v1
        id: md2jira
        with:
          input-text: |
            h3. GitHub Issue Link
            * ${{ github.event.issue.html_url }}

            ${{ github.event.issue.body }}
          mode: md2jira

      # 4. Jira ë¡œê·¸ì¸
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      # 5. Jira ì´ìŠˆ ìƒì„± (parent ì—†ì´)
      - name: Create Jira Issue
        id: create-jira
        uses: atlassian/gajira-create@v3
        with:
          project: ${{ secrets.JIRA_PROJECT || 'FMTW' }}
          issuetype: Task
          summary: "${{ github.event.issue.title }}"
          description: "${{ steps.md2jira.outputs.output-text }}"
      
      # 5-1. Parent í‹°ì¼“ ì—°ê²° (ì„ íƒì‚¬í•­)
      - name: Link to parent issue
        if: steps.issue-parser.outputs.issueparser_parentKey != ''
        continue-on-error: true
        run: |
          PARENT_KEY="${{ steps.issue-parser.outputs.issueparser_parentKey }}"
          ISSUE_KEY="${{ steps.create-jira.outputs.issue }}"
          
          if [ -n "$PARENT_KEY" ]; then
            echo "ğŸ”— Linking to parent: $PARENT_KEY"
            curl -X POST \
              -H "Content-Type: application/json" \
              -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
              -d "{\"update\":{\"parent\":[{\"set\":{\"key\":\"${PARENT_KEY}\"}}]}}" \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${ISSUE_KEY}"
          fi

      # 6. ìƒì„±ëœ Jira ì´ìŠˆ ì •ë³´ ë¡œê·¸
      - name: Log created Jira issue
        run: |
          echo "âœ… Jira Issue Created: ${{ steps.create-jira.outputs.issue }}"
          echo "ğŸ”— Issue URL: ${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.create-jira.outputs.issue }}"

      # 7. develop ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          token: ${{ secrets.GITHUB_TOKEN }}

      # 8. Git ì„¤ì •
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 9. ë¸Œëœì¹˜ ìƒì„± ë° í‘¸ì‹œ
      - name: Create and push branch
        id: create-branch
        run: |
          ISSUE_NUMBER="${{ steps.create-jira.outputs.issue }}"
          ISSUE_TITLE="${{ steps.issue-parser.outputs.issueparser_branch }}"
          BRANCH_NAME="${ISSUE_NUMBER}-$(echo "${ISSUE_TITLE}" | sed 's/ /-/g' | sed 's/[^a-zA-Z0-9-]//g')"

          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

          git checkout -b "${BRANCH_NAME}"
          git push origin "${BRANCH_NAME}"

          echo "âœ… Branch created: ${BRANCH_NAME}"

      # 10. Jiraì— ë¸Œëœì¹˜ ë§í¬ ì½”ë©˜íŠ¸ ì¶”ê°€
      - name: Add branch link to Jira
        run: |
          BRANCH_NAME="${{ steps.create-branch.outputs.branch_name }}"
          ISSUE_NUMBER="${{ steps.create-jira.outputs.issue }}"
          BRANCH_URL="${{ github.server_url }}/${{ github.repository }}/tree/${BRANCH_NAME}"

          curl -X POST \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{\"body\": \"ğŸŒ¿ Branch created: [${BRANCH_NAME}|${BRANCH_URL}]\"}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${ISSUE_NUMBER}/comment"

      # 11. GitHub ì´ìŠˆ ì œëª© ì—…ë°ì´íŠ¸
      - name: Update GitHub issue title
        uses: actions-cool/issues-helper@v3
        with:
          actions: "update-issue"
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "[${{ steps.create-jira.outputs.issue }}] ${{ github.event.issue.title }}"

      # 12. GitHub ì´ìŠˆì— Jira ë§í¬ ì½”ë©˜íŠ¸ ì¶”ê°€
      - name: Add Jira link to GitHub issue
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## âœ… Jira Issue Created

            **Jira Ticket:** [${{ steps.create-jira.outputs.issue }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.create-jira.outputs.issue }})
            **Branch:** `${{ steps.create-branch.outputs.branch_name }}`

            ### ğŸš€ Next Steps
            1. `git fetch origin`
            2. `git checkout -b ${{ steps.create-branch.outputs.branch_name }} origin/${{ steps.create-branch.outputs.branch_name }}`
            3. Start coding!

      # 13. ì—ëŸ¬ ì²˜ë¦¬ - ì‹¤íŒ¨ ì‹œ GitHub ì´ìŠˆì— ì½”ë©˜íŠ¸
      - name: Comment on failure
        if: failure()
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## âŒ Jira Issue Creation Failed

            ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒì„ í™•ì¸í•´ì£¼ì„¸ìš”:

            1. **GitHub Secrets ì„¤ì • í™•ì¸**
               - `JIRA_BASE_URL`
               - `JIRA_USER_EMAIL`
               - `JIRA_API_TOKEN`
               - `JIRA_PROJECT`

            2. **Jira ê¶Œí•œ í™•ì¸**
               - API í† í°ì´ ìœ íš¨í•œì§€
               - í”„ë¡œì íŠ¸ ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ”ì§€

            3. **ì›Œí¬í”Œë¡œìš° ë¡œê·¸ í™•ì¸**
               - [Actions íƒ­](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})ì—ì„œ ìƒì„¸ ë¡œê·¸ í™•ì¸

            ### ğŸ”§ ì„¤ì • ë°©ë²•
            ```bash
            npm run jira:setup
            ```
