name: Chromatic CI/CD

on:
  # main ë¸Œëœì¹˜ë¡œ í–¥í•˜ëŠ” PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œ
  pull_request:
    branches: [main]
  # main ë¸Œëœì¹˜ì— push ì‹œ (merge í›„)
  push:
    branches: [main]

jobs:
  chromatic:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Chromaticì—ì„œ ë³€ê²½ì‚¬í•­ ë¹„êµë¥¼ ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš”

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: Storybook ë¹Œë“œ ê²€ì¦
        run: npm run build-storybook

      - name: Chromatic ë°°í¬
        id: chromatic
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          # PRì¸ ê²½ìš° ë³€ê²½ì‚¬í•­ì´ ìˆì–´ë„ ì‹¤íŒ¨í•˜ì§€ ì•ŠìŒ
          exitZeroOnChanges: ${{ github.event_name == 'pull_request' }}
          # main ë¸Œëœì¹˜ì¸ ê²½ìš° ìë™ìœ¼ë¡œ baseline ìŠ¹ì¸
          autoAcceptChanges: ${{ github.ref == 'refs/heads/main' }}

      - name: ë°°í¬ ê²°ê³¼ Summary ìƒì„±
        if: always()
        run: |
          echo "## ğŸ¨ Chromatic ë°°í¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š ë°°í¬ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ë‚´ìš© |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŒ Storybook | [ë°°í¬ëœ Storybook ë³´ê¸°](${{ steps.chromatic.outputs.storybookUrl }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Chromatic Build | [ë¹Œë“œ ìƒì„¸ë³´ê¸°](${{ steps.chromatic.outputs.buildUrl }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“š í…ŒìŠ¤íŠ¸ëœ ìŠ¤í† ë¦¬ | ${{ steps.chromatic.outputs.specCount }}ê°œ |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¯ ë³€ê²½ì‚¬í•­ | ${{ steps.chromatic.outputs.changeCount }}ê°œ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.chromatic.outputs.changeCount }}" -gt "0" ]; then
            echo "### âš ï¸ ë¹„ì£¼ì–¼ ë³€ê²½ì‚¬í•­ ê°ì§€" >> $GITHUB_STEP_SUMMARY
            echo "UI ë³€ê²½ì‚¬í•­ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. [Chromatic](${{ steps.chromatic.outputs.buildUrl }})ì—ì„œ í™•ì¸ í›„ ìŠ¹ì¸í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… ë¹„ì£¼ì–¼ ë³€ê²½ì‚¬í•­ ì—†ìŒ" >> $GITHUB_STEP_SUMMARY
            echo "ì´ì „ ë¹Œë“œì™€ ë¹„êµí•˜ì—¬ UI ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi

      - name: PRì— ë°°í¬ ì •ë³´ ì½”ë©˜íŠ¸ ì¶”ê°€
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const changeCount = '${{ steps.chromatic.outputs.changeCount }}';
            const specCount = '${{ steps.chromatic.outputs.specCount }}';
            const storybookUrl = '${{ steps.chromatic.outputs.storybookUrl }}';
            const buildUrl = '${{ steps.chromatic.outputs.buildUrl }}';

            let statusEmoji = 'âœ…';
            let statusText = 'ë¹„ì£¼ì–¼ ë³€ê²½ì‚¬í•­ ì—†ìŒ';
            let additionalInfo = 'ì´ì „ ë¹Œë“œì™€ ë¹„êµí•˜ì—¬ UI ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.';

            if (parseInt(changeCount) > 0) {
              statusEmoji = 'âš ï¸';
              statusText = `ë¹„ì£¼ì–¼ ë³€ê²½ì‚¬í•­ ${changeCount}ê°œ ê°ì§€`;
              additionalInfo = `UI ë³€ê²½ì‚¬í•­ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. [Chromatic](${buildUrl})ì—ì„œ í™•ì¸ í›„ ìŠ¹ì¸í•´ì£¼ì„¸ìš”.`;
            }

            const comment = `## ğŸ¨ Chromatic ë°°í¬ ì™„ë£Œ

            ${statusEmoji} **${statusText}**

            ### ğŸ“Š ë°°í¬ ì •ë³´
            | í•­ëª© | ë‚´ìš© |
            |------|------|
            | ğŸŒ Storybook | [ë°°í¬ëœ Storybook ë³´ê¸°](${storybookUrl}) |
            | ğŸ” Chromatic Build | [ë¹Œë“œ ìƒì„¸ë³´ê¸°](${buildUrl}) |
            | ğŸ“š í…ŒìŠ¤íŠ¸ëœ ìŠ¤í† ë¦¬ | ${specCount}ê°œ |
            | ğŸ¯ ë³€ê²½ì‚¬í•­ | ${changeCount}ê°œ |

            ${additionalInfo}`;

            // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ¨ Chromatic ë°°í¬ ì™„ë£Œ')
            );

            // ê¸°ì¡´ ì½”ë©˜íŠ¸ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
