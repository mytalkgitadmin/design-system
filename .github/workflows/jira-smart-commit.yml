name: Jira Smart Commit

on:
  push:
    branches:
      - '**'  # ëª¨ë“  ë¸Œëžœì¹˜
    paths-ignore:
      - '**.md'
      - '.github/**'

jobs:
  process-smart-commits:
    name: Process Smart Commits
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (ìŠ¤ë§ˆíŠ¸ ì»¤ë°‹ ë²”ìœ„ ê³„ì‚°ìš©)

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Get commit messages
        id: commits
        run: |
          # í‘¸ì‹œëœ ì»¤ë°‹ë“¤ì˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # ìƒˆ ë¸Œëžœì¹˜ì¸ ê²½ìš° ìµœê·¼ 1ê°œ ì»¤ë°‹ë§Œ
            echo "ðŸ“Œ ìƒˆ ë¸Œëžœì¹˜ ê°ì§€: ìµœê·¼ 1ê°œ ì»¤ë°‹ ì²˜ë¦¬"
            git log -1 --pretty=format:"%H|%s|%b" > commits.txt
          else
            # ì´ì „ ì»¤ë°‹ì´ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸ (force push ëŒ€ì‘)
            if git rev-parse --verify "${{ github.event.before }}" >/dev/null 2>&1; then
              # ê¸°ì¡´ ë¸Œëžœì¹˜ì¸ ê²½ìš° before..after ë²”ìœ„
              echo "ðŸ“ ì»¤ë°‹ ë²”ìœ„: ${{ github.event.before }}..${{ github.event.after }}"
              git log ${{ github.event.before }}..${{ github.event.after }} --pretty=format:"%H|%s|%b" > commits.txt
            else
              # Force push ë˜ëŠ” rebaseë¡œ ì´ì „ ì»¤ë°‹ì´ ì—†ëŠ” ê²½ìš°
              echo "âš ï¸  Force push ê°ì§€: ì´ì „ ì»¤ë°‹(${{ github.event.before }})ì´ ížˆìŠ¤í† ë¦¬ì— ì—†ìŠµë‹ˆë‹¤"
              echo "ðŸ“Œ ìµœê·¼ 1ê°œ ì»¤ë°‹ë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤"
              git log -1 --pretty=format:"%H|%s|%b" > commits.txt
            fi
          fi
          
          echo "ì»¤ë°‹ ê°œìˆ˜: $(wc -l < commits.txt)"
          cat commits.txt

      - name: Process smart commits
        run: node scripts/jira/process-smart-commits.js
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REF: ${{ github.ref }}

      - name: Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ Jira Smart Commit ì²˜ë¦¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commits:** $(wc -l < commits.txt)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ìžì„¸í•œ ë‚´ìš©ì€ ì›Œí¬í”Œë¡œìš° ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY

