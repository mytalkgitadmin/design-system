name: Jira Auto Complete on PR Merge

on:
  pull_request:
    types: [closed]
    branches:
      - develop

jobs:
  auto-complete-jira:
    name: Auto Complete Jira Ticket
    runs-on: ubuntu-latest
    
    # PRì´ ì‹¤ì œë¡œ ë¨¸ì§€ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: github.event.pull_request.merged == true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Jira ticket from branch name
        id: extract-ticket
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          echo "Branch name: $BRANCH_NAME"
          
          # ì •ê·œì‹ìœ¼ë¡œ Jira í‹°ì¼“ ì¶”ì¶œ (ì˜ˆ: AUR-6-fe-task-pr â†’ AUR-6)
          JIRA_KEY=$(echo "$BRANCH_NAME" | grep -oE '[A-Z]+-[0-9]+' | head -1)
          
          if [ -z "$JIRA_KEY" ]; then
            echo "âš ï¸  ë¸Œëžœì¹˜ëª…ì—ì„œ Jira í‹°ì¼“ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $BRANCH_NAME"
            echo "has_ticket=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Jira í‹°ì¼“ ë°œê²¬: $JIRA_KEY"
            echo "has_ticket=true" >> $GITHUB_OUTPUT
            echo "ticket=$JIRA_KEY" >> $GITHUB_OUTPUT
          fi

      - name: Get transition ID from config
        id: get-transition
        if: steps.extract-ticket.outputs.has_ticket == 'true'
        run: |
          if [ -f "scripts/jira/jira-workflow-config.json" ]; then
            END_TRANSITION_ID=$(jq -r '.mappings.end // ""' scripts/jira/jira-workflow-config.json)
            
            if [ -n "$END_TRANSITION_ID" ] && [ "$END_TRANSITION_ID" != "null" ]; then
              echo "transition_id=$END_TRANSITION_ID" >> $GITHUB_OUTPUT
              echo "has_transition=true" >> $GITHUB_OUTPUT
              echo "âœ… Transition ID: $END_TRANSITION_ID"
            else
              echo "has_transition=false" >> $GITHUB_OUTPUT
              echo "âš ï¸  jira-workflow-config.jsonì— 'end' transition IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            fi
          else
            echo "has_transition=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  jira-workflow-config.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: Transition Jira ticket to complete
        if: steps.extract-ticket.outputs.has_ticket == 'true' && steps.get-transition.outputs.has_transition == 'true'
        continue-on-error: true
        run: |
          ISSUE_KEY="${{ steps.extract-ticket.outputs.ticket }}"
          TRANSITION_ID="${{ steps.get-transition.outputs.transition_id }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ¯ Jira í‹°ì¼“ ìƒíƒœ ë³€ê²½ ì‹œìž‘"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“‹ Ticket: $ISSUE_KEY"
          echo "ðŸ”„ Transition ID: $TRANSITION_ID"
          echo "ðŸ”— PR: #$PR_NUMBER"
          echo ""
          
          # Jira í‹°ì¼“ ìƒíƒœ ë³€ê²½
          TRANSITION_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{\"transition\":{\"id\":\"${TRANSITION_ID}\"}}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${ISSUE_KEY}/transitions")
          
          TRANSITION_HTTP_CODE=$(echo "$TRANSITION_RESPONSE" | tail -n 1)
          
          if [ "$TRANSITION_HTTP_CODE" = "204" ] || [ "$TRANSITION_HTTP_CODE" = "200" ]; then
            echo "âœ… Jira í‹°ì¼“ ìƒíƒœê°€ 'ì™„ë£Œ'ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤"
          else
            echo "âš ï¸  Jira ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨ (HTTP $TRANSITION_HTTP_CODE)"
            echo "ì‘ë‹µ: $(echo "$TRANSITION_RESPONSE" | head -n -1)"
            echo ""
            echo "ðŸ’¡ ê°€ëŠ¥í•œ ì›ì¸:"
            echo "  - ì´ë¯¸ 'ì™„ë£Œ' ìƒíƒœì¸ í‹°ì¼“"
            echo "  - ìž˜ëª»ëœ transition ID (scripts/jira/jira-workflow-config.json í™•ì¸)"
            echo "  - ì›Œí¬í”Œë¡œìš° ê¶Œí•œ ë¬¸ì œ"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ’¬ Jira ì½”ë©˜íŠ¸ ì¶”ê°€ ì¤‘..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Jiraì— PR ë¨¸ì§€ ì½”ë©˜íŠ¸ ì¶”ê°€
          COMMENT_TEXT="ðŸŽ‰ PRì´ develop ë¸Œëžœì¹˜ì— ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤\n\n*PR:* [#${PR_NUMBER} ${PR_TITLE}|${PR_URL}]\n*Branch:* \`${{ github.event.pull_request.head.ref }}\`\n*Merged by:* ${{ github.actor }}"
          
          COMMENT_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{\"body\":\"${COMMENT_TEXT}\"}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${ISSUE_KEY}/comment")
          
          COMMENT_HTTP_CODE=$(echo "$COMMENT_RESPONSE" | tail -n 1)
          
          if [ "$COMMENT_HTTP_CODE" = "201" ] || [ "$COMMENT_HTTP_CODE" = "200" ]; then
            echo "âœ… Jiraì— PR ë¨¸ì§€ ì½”ë©˜íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤"
          else
            echo "âš ï¸  ì½”ë©˜íŠ¸ ì¶”ê°€ ì‹¤íŒ¨ (HTTP $COMMENT_HTTP_CODE)"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ì™„ë£Œ!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Create summary
        if: steps.extract-ticket.outputs.has_ticket == 'true'
        run: |
          ISSUE_KEY="${{ steps.extract-ticket.outputs.ticket }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          echo "## ðŸŽ‰ Jira ìžë™ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Jira Ticket:** [\`${ISSUE_KEY}\`](${{ secrets.JIRA_BASE_URL }}/browse/${ISSUE_KEY})" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** [#${PR_NUMBER}](${{ github.event.pull_request.html_url }})" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.event.pull_request.head.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.get-transition.outputs.has_transition }}" = "true" ]; then
            echo "âœ… Jira í‹°ì¼“ì´ ìžë™ìœ¼ë¡œ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Transition IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ìƒíƒœ ë³€ê²½ì„ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ì„¤ì • ë°©ë²•:** \`scripts/jira/jira-workflow-config.json\`ì— \`end\` transition IDë¥¼ ì¶”ê°€í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Skip summary (no ticket)
        if: steps.extract-ticket.outputs.has_ticket == 'false'
        run: |
          echo "## â„¹ï¸ Jira í‹°ì¼“ ì—†ìŒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ë¸Œëžœì¹˜ëª…ì—ì„œ Jira í‹°ì¼“ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ìžë™ ì™„ë£Œë¥¼ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.event.pull_request.head.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ ë¸Œëžœì¹˜ëª… í˜•ì‹: \`AUR-123-description\` ë˜ëŠ” \`feature/AUR-123-description\`" >> $GITHUB_STEP_SUMMARY

