name: Create Jira Issue (Manual)

on:
  workflow_dispatch:
    inputs:
      title:
        description: 'ì´ìŠˆ ì œëª©'
        required: true
        type: string
      description:
        description: 'ì´ìŠˆ ì„¤ëª…'
        required: false
        type: string
        default: ''
      parent_key:
        description: 'ìƒìœ„ í‹°ì¼“ ë²ˆí˜¸ (ì˜ˆ: PRJ-123)'
        required: false
        type: string
        default: ''
      issue_type:
        description: 'ì´ìŠˆ íƒ€ìž…'
        required: true
        type: choice
        options:
          - Task
          - Story
          - Bug
        default: Task

jobs:
  create-jira-only:
    name: Create Jira Issue
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      - name: Create Jira Issue
        id: create-jira
        uses: atlassian/gajira-create@v3
        with:
          project: ${{ secrets.JIRA_PROJECT }}
          issuetype: ${{ inputs.issue_type }}
          summary: "${{ inputs.title }}"
          description: "${{ inputs.description }}"

      - name: Link to parent issue
        if: inputs.parent_key != ''
        continue-on-error: true
        run: |
          PARENT_KEY="${{ inputs.parent_key }}"
          ISSUE_KEY="${{ steps.create-jira.outputs.issue }}"

          if [ -n "$PARENT_KEY" ] && [ "$PARENT_KEY" != "null" ]; then
            echo "ðŸ”— Linking to parent: $PARENT_KEY"
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
              -H "Content-Type: application/json" \
              -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
              -d "{\"fields\":{\"parent\":{\"key\":\"${PARENT_KEY}\"}}}" \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${ISSUE_KEY}")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
            if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Successfully linked to parent: $PARENT_KEY"
            else
              echo "âš ï¸  Failed to link parent (HTTP $HTTP_CODE). Task created without parent."
            fi
          fi

      - name: Set Jira ticket to init status
        continue-on-error: true
        run: |
          ISSUE_KEY="${{ steps.create-jira.outputs.issue }}"

          if [ -f "scripts/jira/jira-workflow-config.json" ]; then
            INIT_TRANSITION_ID=$(jq -r '.mappings.init // ""' scripts/jira/jira-workflow-config.json)
            
            if [ -n "$INIT_TRANSITION_ID" ] && [ "$INIT_TRANSITION_ID" != "null" ]; then
              echo "ðŸ”„ Jira í‹°ì¼“ ìƒíƒœë¥¼ initìœ¼ë¡œ ë³€ê²½ ì¤‘... (Transition ID: ${INIT_TRANSITION_ID})"
              
              RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                -H "Content-Type: application/json" \
                -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
                -d "{\"transition\":{\"id\":\"${INIT_TRANSITION_ID}\"}}" \
                "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${ISSUE_KEY}/transitions")
              
              HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
              if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
                echo "âœ… Jira í‹°ì¼“ ìƒíƒœê°€ initìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤"
              else
                echo "âš ï¸  Jira ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨ (HTTP $HTTP_CODE). ê¸°ë³¸ ìƒíƒœë¡œ ìœ ì§€ë©ë‹ˆë‹¤."
              fi
            else
              echo "â­ï¸  init transition IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒíƒœ ë³€ê²½ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            fi
          else
            echo "â­ï¸  jira-workflow-config.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒíƒœ ë³€ê²½ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      - name: Save Jira ticket info to file
        run: |
          echo "${{ steps.create-jira.outputs.issue }}" > jira-ticket.txt
          echo "${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.create-jira.outputs.issue }}" >> jira-ticket.txt
          if [ -n "${{ inputs.parent_key }}" ]; then
            echo "${{ inputs.parent_key }}" >> jira-ticket.txt
          fi
          
          echo "âœ… Jira Issue Created: ${{ steps.create-jira.outputs.issue }}"
          echo "ðŸ”— Issue URL: ${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.create-jira.outputs.issue }}"
          
          if [ -n "${{ inputs.parent_key }}" ]; then
            echo "ðŸ“Ž Parent Ticket: ${{ inputs.parent_key }}"
          fi

      - name: Upload Jira ticket info
        uses: actions/upload-artifact@v4
        with:
          name: jira-ticket-info
          path: jira-ticket.txt
          retention-days: 1

      - name: Create summary comment
        run: |
          ISSUE_KEY="${{ steps.create-jira.outputs.issue }}"
          ISSUE_URL="${{ secrets.JIRA_BASE_URL }}/browse/${ISSUE_KEY}"
          
          echo "## ðŸŽ‰ Jira ì´ìŠˆ ìƒì„± ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Jira Ticket:** [${ISSUE_KEY}](${ISSUE_URL})" >> $GITHUB_STEP_SUMMARY
          echo "**Issue Type:** ${{ inputs.issue_type }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ inputs.parent_key }}" ]; then
            echo "**Parent:** ${{ inputs.parent_key }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Œ ë‹¤ìŒ ë‹¨ê³„" >> $GITHUB_STEP_SUMMARY
          echo "1. Jiraì—ì„œ ì´ìŠˆ í™•ì¸" >> $GITHUB_STEP_SUMMARY
          echo "2. í•„ìš”ì‹œ ìž‘ì—… ì‹œìž‘" >> $GITHUB_STEP_SUMMARY
          echo "3. ì½”ë“œ ìž‘ì—… ì§„í–‰" >> $GITHUB_STEP_SUMMARY

