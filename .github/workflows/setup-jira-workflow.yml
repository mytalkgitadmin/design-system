name: Setup Jira Workflow

on:
  workflow_dispatch:
    inputs:
      start_transition:
        description: 'ì‘ì—… ì‹œì‘ Transition ID (ë¹„ì›Œë‘ë©´ ìë™ íƒì§€)'
        required: false
        type: string
      end_transition:
        description: 'ì‘ì—… ì™„ë£Œ Transition ID (ë¹„ì›Œë‘ë©´ ìë™ íƒì§€)'
        required: false
        type: string
      review_transition:
        description: 'ë¦¬ë·° Transition ID (ì„ íƒì‚¬í•­, ë¹„ì›Œë‘ë©´ ìë™ íƒì§€)'
        required: false
        type: string
      blocked_transition:
        description: 'ë¸”ë¡œí‚¹ Transition ID (ì„ íƒì‚¬í•­, ë¹„ì›Œë‘ë©´ ìë™ íƒì§€)'
        required: false
        type: string

jobs:
  setup-workflow:
    name: Setup Jira Workflow Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch Jira workflow from project
        id: fetch-transitions
        run: |
          PROJECT_KEY="${{ secrets.JIRA_PROJECT }}"
          
          echo "ğŸ” í”„ë¡œì íŠ¸ ${PROJECT_KEY}ì˜ ì›Œí¬í”Œë¡œìš° ì¡°íšŒ ì¤‘..."
          
          # í”„ë¡œì íŠ¸ì˜ ëª¨ë“  ìƒíƒœ ì¡°íšŒ
          STATUSES=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/project/${PROJECT_KEY}/statuses")
          
          # ì—ëŸ¬ ì²´í¬
          if echo "$STATUSES" | jq -e '.errorMessages' > /dev/null 2>&1; then
            echo "âŒ Jira API ì—ëŸ¬:"
            echo "$STATUSES" | jq -r '.errorMessages[]'
            exit 1
          fi
          
          # Task íƒ€ì…ì˜ ìƒíƒœë“¤ ì¶”ì¶œ (ê°€ì¥ ì¼ë°˜ì )
          TASK_STATUSES=$(echo "$STATUSES" | jq '[.[] | select(.name == "Task" or .name == "ì‘ì—…" or .id == "10001") | .statuses[]] | unique')
          
          # ìƒíƒœê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ issue type ì‚¬ìš©
          if [ "$TASK_STATUSES" = "[]" ] || [ "$TASK_STATUSES" = "null" ]; then
            echo "âš ï¸  Task íƒ€ì…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ issue type ì‚¬ìš©..."
            TASK_STATUSES=$(echo "$STATUSES" | jq '[.[0].statuses[]] | unique')
          fi
          
          echo "ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ìƒíƒœ ëª©ë¡:"
          echo "$TASK_STATUSES" | jq -r '.[] | "  \(.name) (ID: \(.id))"'
          
          # ìƒ˜í”Œ ì´ìŠˆë¡œ ì‹¤ì œ transition ì¡°íšŒ (ìƒíƒœ IDë¥¼ ì•Œê¸° ìœ„í•¨)
          # í”„ë¡œì íŠ¸ì—ì„œ ìµœê·¼ ì´ìŠˆ í•˜ë‚˜ ê°€ì ¸ì˜¤ê¸°
          echo ""
          echo "ğŸ” ì‹¤ì œ transition ì¡°íšŒë¥¼ ìœ„í•´ ìƒ˜í”Œ ì´ìŠˆ ê²€ìƒ‰ ì¤‘..."
          SEARCH_RESULT=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/search?jql=project=${PROJECT_KEY}&maxResults=1")
          
          SAMPLE_ISSUE=$(echo "$SEARCH_RESULT" | jq -r '.issues[0].key')
          
          if [ -z "$SAMPLE_ISSUE" ] || [ "$SAMPLE_ISSUE" = "null" ]; then
            echo "âŒ í”„ë¡œì íŠ¸ì— ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤. ì´ìŠˆë¥¼ í•˜ë‚˜ ìƒì„±í•´ì£¼ì„¸ìš”."
            exit 1
          fi
          
          echo "âœ… ìƒ˜í”Œ ì´ìŠˆ ë°œê²¬: $SAMPLE_ISSUE"
          echo ""
          
          # ì‹¤ì œ transition ì¡°íšŒ
          TRANSITIONS=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${SAMPLE_ISSUE}/transitions")
          
          echo "ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ Transition ëª©ë¡:"
          echo "$TRANSITIONS" | jq -r '.transitions[] | "  ID: \(.id) | \(.name) â†’ \(.to.name)"'
          
          # transitions ë°ì´í„°ë¥¼ outputìœ¼ë¡œ ì €ì¥
          echo "transitions<<EOF" >> $GITHUB_OUTPUT
          echo "$TRANSITIONS" | jq '.transitions'
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "sample_issue=$SAMPLE_ISSUE" >> $GITHUB_OUTPUT

      - name: Auto-detect transitions if not provided
        id: auto-detect
        run: |
          TRANSITIONS='${{ steps.fetch-transitions.outputs.transitions }}'
          
          START_ID="${{ github.event.inputs.start_transition }}"
          END_ID="${{ github.event.inputs.end_transition }}"
          REVIEW_ID="${{ github.event.inputs.review_transition }}"
          BLOCKED_ID="${{ github.event.inputs.blocked_transition }}"
          
          # ì…ë ¥ì´ ì—†ìœ¼ë©´ ìë™ íƒì§€
          if [ -z "$START_ID" ]; then
            echo "ğŸ” ì‘ì—… ì‹œì‘ transition ìë™ íƒì§€ ì¤‘..."
            START_ID=$(echo "$TRANSITIONS" | jq -r '.[] | select(
              (.to.name | ascii_downcase) == "in progress" or
              (.to.name | ascii_downcase) == "ì§„í–‰ ì¤‘" or
              (.to.name | ascii_downcase) == "ì§„í–‰ì¤‘"
            ) | .id' | head -n 1)
            
            if [ -n "$START_ID" ] && [ "$START_ID" != "null" ]; then
              START_NAME=$(echo "$TRANSITIONS" | jq -r ".[] | select(.id == \"$START_ID\") | .to.name")
              echo "âœ… ìë™ íƒì§€: ì‘ì—… ì‹œì‘ = ID:$START_ID ($START_NAME)"
            fi
          fi
          
          if [ -z "$END_ID" ]; then
            echo "ğŸ” ì‘ì—… ì™„ë£Œ transition ìë™ íƒì§€ ì¤‘..."
            END_ID=$(echo "$TRANSITIONS" | jq -r '.[] | select(
              (.to.name | ascii_downcase) == "done" or
              (.to.name | ascii_downcase) == "ì™„ë£Œ" or
              (.to.name | ascii_downcase) == "í•´ê²°ë¨"
            ) | .id' | head -n 1)
            
            if [ -n "$END_ID" ] && [ "$END_ID" != "null" ]; then
              END_NAME=$(echo "$TRANSITIONS" | jq -r ".[] | select(.id == \"$END_ID\") | .to.name")
              echo "âœ… ìë™ íƒì§€: ì‘ì—… ì™„ë£Œ = ID:$END_ID ($END_NAME)"
            fi
          fi
          
          if [ -z "$REVIEW_ID" ]; then
            REVIEW_ID=$(echo "$TRANSITIONS" | jq -r '.[] | select(
              (.to.name | ascii_downcase) | contains("review") or
              (.to.name | ascii_downcase) | contains("ë¦¬ë·°")
            ) | .id' | head -n 1)
            
            if [ -n "$REVIEW_ID" ] && [ "$REVIEW_ID" != "null" ]; then
              REVIEW_NAME=$(echo "$TRANSITIONS" | jq -r ".[] | select(.id == \"$REVIEW_ID\") | .to.name")
              echo "âœ… ìë™ íƒì§€: ë¦¬ë·° = ID:$REVIEW_ID ($REVIEW_NAME)"
            fi
          fi
          
          if [ -z "$BLOCKED_ID" ]; then
            BLOCKED_ID=$(echo "$TRANSITIONS" | jq -r '.[] | select(
              (.to.name | ascii_downcase) | contains("block") or
              (.to.name | ascii_downcase) | contains("ë¸”ë¡œí‚¹")
            ) | .id' | head -n 1)
            
            if [ -n "$BLOCKED_ID" ] && [ "$BLOCKED_ID" != "null" ]; then
              BLOCKED_NAME=$(echo "$TRANSITIONS" | jq -r ".[] | select(.id == \"$BLOCKED_ID\") | .to.name")
              echo "âœ… ìë™ íƒì§€: ë¸”ë¡œí‚¹ = ID:$BLOCKED_ID ($BLOCKED_NAME)"
            fi
          fi
          
          echo "start_id=$START_ID" >> $GITHUB_OUTPUT
          echo "end_id=$END_ID" >> $GITHUB_OUTPUT
          echo "review_id=$REVIEW_ID" >> $GITHUB_OUTPUT
          echo "blocked_id=$BLOCKED_ID" >> $GITHUB_OUTPUT

      - name: Create workflow config file
        run: |
          SAMPLE_ISSUE="${{ steps.fetch-transitions.outputs.sample_issue }}"
          PROJECT_KEY="${{ secrets.JIRA_PROJECT }}"
          TRANSITIONS='${{ steps.fetch-transitions.outputs.transitions }}'
          START_ID="${{ steps.auto-detect.outputs.start_id }}"
          END_ID="${{ steps.auto-detect.outputs.end_id }}"
          REVIEW_ID="${{ steps.auto-detect.outputs.review_id }}"
          BLOCKED_ID="${{ steps.auto-detect.outputs.blocked_id }}"
          
          # null ê°’ ì²˜ë¦¬
          [ "$START_ID" = "null" ] && START_ID=""
          [ "$END_ID" = "null" ] && END_ID=""
          [ "$REVIEW_ID" = "null" ] && REVIEW_ID=""
          [ "$BLOCKED_ID" = "null" ] && BLOCKED_ID=""
          
          cat > scripts/jira/jira-workflow-config.json << EOF
          {
            "lastUpdated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "projectKey": "$PROJECT_KEY",
            "sampleIssue": "$SAMPLE_ISSUE",
            "jiraBaseUrl": "${{ secrets.JIRA_BASE_URL }}",
            "transitions": $(echo "$TRANSITIONS" | jq 'map({
              id: .id,
              name: .name,
              toStatus: .to.name,
              toStatusId: .to.id
            })'),
            "mappings": {
              "start": $([ -n "$START_ID" ] && echo "\"$START_ID\"" || echo "null"),
              "end": $([ -n "$END_ID" ] && echo "\"$END_ID\"" || echo "null"),
              "inProgress": $([ -n "$START_ID" ] && echo "\"$START_ID\"" || echo "null"),
              "review": $([ -n "$REVIEW_ID" ] && echo "\"$REVIEW_ID\"" || echo "null"),
              "blocked": $([ -n "$BLOCKED_ID" ] && echo "\"$BLOCKED_ID\"" || echo "null")
            }
          }
          EOF
          
          echo "âœ… ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ"
          echo ""
          echo "ğŸ“„ ì €ì¥ëœ ì„¤ì •:"
          cat scripts/jira/jira-workflow-config.json | jq '.'

      - name: Commit and push config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add scripts/jira/jira-workflow-config.json
          
          if git diff --cached --quiet; then
            echo "âš ï¸  ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          else
            COMMIT_MSG=$(cat <<EOF
          chore: Update Jira workflow configuration
          
          Project: ${{ secrets.JIRA_PROJECT }}
          Sample issue: ${{ steps.fetch-transitions.outputs.sample_issue }}
          
          Configured transitions:
          - Start: ${{ steps.auto-detect.outputs.start_id }}
          - End: ${{ steps.auto-detect.outputs.end_id }}
          - Review: ${{ steps.auto-detect.outputs.review_id }}
          - Blocked: ${{ steps.auto-detect.outputs.blocked_id }}
          EOF
          )
            
            git commit -m "$COMMIT_MSG"
            git push
            echo "âœ… ì„¤ì • íŒŒì¼ì´ ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤!"
          fi

      - name: Create summary comment
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-issue'
          token: ${{ secrets.GITHUB_TOKEN }}
          title: 'âœ… Jira Workflow ì„¤ì • ì™„ë£Œ'
          body: |
            ## ğŸ‰ Jira Workflow ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
            
            **í”„ë¡œì íŠ¸**: ${{ secrets.JIRA_PROJECT }}
            **ìƒ˜í”Œ ì´ìŠˆ**: ${{ steps.fetch-transitions.outputs.sample_issue }}
            **ì„¤ì • ì‹œê°„**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            ### ğŸ“‹ ì„¤ì •ëœ Transition
            
            | ì•¡ì…˜ | Transition ID | ìƒíƒœ |
            |------|--------------|------|
            | ì‘ì—… ì‹œì‘ | `${{ steps.auto-detect.outputs.start_id }}` | ${{ steps.auto-detect.outputs.start_id != '' && 'âœ…' || 'âš ï¸ ë¯¸ì„¤ì •' }} |
            | ì‘ì—… ì™„ë£Œ | `${{ steps.auto-detect.outputs.end_id }}` | ${{ steps.auto-detect.outputs.end_id != '' && 'âœ…' || 'âš ï¸ ë¯¸ì„¤ì •' }} |
            | ë¦¬ë·° | `${{ steps.auto-detect.outputs.review_id }}` | ${{ steps.auto-detect.outputs.review_id != '' && 'âœ…' || 'âš ï¸ ë¯¸ì„¤ì •' }} |
            | ë¸”ë¡œí‚¹ | `${{ steps.auto-detect.outputs.blocked_id }}` | ${{ steps.auto-detect.outputs.blocked_id != '' && 'âœ…' || 'âš ï¸ ë¯¸ì„¤ì •' }} |
            
            ### ğŸ“– ì‚¬ìš© ê°€ëŠ¥í•œ Transition ëª©ë¡
            
            ```json
            ${{ steps.fetch-transitions.outputs.transitions }}
            ```
            
            ### ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„
            
            - ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”
            - `npm run issue:start`, `npm run issue:end` ëª…ë ¹ì–´ê°€ ì´ì œ ì´ ì„¤ì •ì„ ì‚¬ìš©í•©ë‹ˆë‹¤
            - ìˆ˜ì •ì´ í•„ìš”í•˜ë©´ Actions íƒ­ì—ì„œ "Setup Jira Workflow"ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”
            
            **ì„¤ì • íŒŒì¼**: `scripts/jira/jira-workflow-config.json`
          labels: 'jira,automation,config'

