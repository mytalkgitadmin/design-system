name: Setup Jira Workflow

on:
  workflow_dispatch:
    inputs:
      start_transition:
        description: "ì‘ì—… ì‹œì‘ Transition ID (ë¹„ì›Œë‘ë©´ ìë™ íƒì§€)"
        required: false
        type: string
      end_transition:
        description: "ì‘ì—… ì™„ë£Œ Transition ID (ë¹„ì›Œë‘ë©´ ìë™ íƒì§€)"
        required: false
        type: string
      review_transition:
        description: "ë¦¬ë·° Transition ID (ì„ íƒì‚¬í•­, ë¹„ì›Œë‘ë©´ ìë™ íƒì§€)"
        required: false
        type: string
      blocked_transition:
        description: "ë¸”ë¡œí‚¹ Transition ID (ì„ íƒì‚¬í•­, ë¹„ì›Œë‘ë©´ ìë™ íƒì§€)"
        required: false
        type: string

jobs:
  setup-workflow:
    name: Setup Jira Workflow Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch Jira workflow from project
        id: fetch-transitions
        run: |
          PROJECT_KEY="${{ secrets.JIRA_PROJECT }}"

          echo "ğŸ” í”„ë¡œì íŠ¸ ${PROJECT_KEY}ì˜ ì›Œí¬í”Œë¡œìš° ì¡°íšŒ ì¤‘..."

          # 1. í”„ë¡œì íŠ¸ì˜ Issue Type ëª©ë¡ ì¡°íšŒ
          echo "ğŸ“‹ Issue Type ëª©ë¡ ì¡°íšŒ ì¤‘..."
          PROJECT_INFO=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/project/${PROJECT_KEY}")

          # ì—ëŸ¬ ì²´í¬
          if echo "$PROJECT_INFO" | jq -e '.errorMessages' > /dev/null 2>&1; then
            echo "âŒ Jira API ì—ëŸ¬:"
            echo "$PROJECT_INFO" | jq -r '.errorMessages[]'
            exit 1
          fi

          # Task Issue Type ID ì°¾ê¸°
          ISSUE_TYPE_ID=$(echo "$PROJECT_INFO" | jq -r '.issueTypes[] | select(.name == "Task" or .name == "ì‘ì—…") | .id' | head -n 1)

          # Taskê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ Issue Type ì‚¬ìš©
          if [ -z "$ISSUE_TYPE_ID" ] || [ "$ISSUE_TYPE_ID" = "null" ]; then
            echo "âš ï¸  Task íƒ€ì…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ Issue Type ì‚¬ìš©..."
            ISSUE_TYPE_ID=$(echo "$PROJECT_INFO" | jq -r '.issueTypes[0].id')
          fi

          ISSUE_TYPE_NAME=$(echo "$PROJECT_INFO" | jq -r ".issueTypes[] | select(.id == \"$ISSUE_TYPE_ID\") | .name")
          echo "âœ… Issue Type: $ISSUE_TYPE_NAME (ID: $ISSUE_TYPE_ID)"

          # 2. Create Metadataë¡œ workflow ì •ë³´ ì¡°íšŒ (ì´ìŠˆ ì—†ì´!)
          echo ""
          echo "ğŸ” Workflow ë©”íƒ€ë°ì´í„° ì¡°íšŒ ì¤‘..."
          CREATE_META=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/createmeta?projectKeys=${PROJECT_KEY}&issuetypeIds=${ISSUE_TYPE_ID}&expand=projects.issuetypes.fields")

          # ìƒíƒœ ë° transition ì •ë³´ ì¶”ì¶œ
          STATUSES=$(echo "$CREATE_META" | jq '[.projects[0].issuetypes[0].fields.status.allowedValues[]] | unique')

          echo "ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ìƒíƒœ ëª©ë¡:"
          echo "$STATUSES" | jq -r '.[] | "  \(.name) (ID: \(.id))"'

          # 3. ìƒíƒœ ê°„ transition ë§¤í•‘ ìƒì„± (ì¼ë°˜ì ì¸ íŒ¨í„´ ì‚¬ìš©)
          echo ""
          echo "ğŸ”„ Transition ë§¤í•‘ ìƒì„± ì¤‘..."

          # ê° ìƒíƒœì˜ ID ì¶”ì¶œ
          TODO_ID=$(echo "$STATUSES" | jq -r '.[] | select(.name == "í•´ì•¼ í•  ì¼" or .name == "To Do" or .name == "Open" or .name == "ë¯¸í•´ê²°") | .id' | head -n 1)
          INPROGRESS_ID=$(echo "$STATUSES" | jq -r '.[] | select(.name == "ì§„í–‰ ì¤‘" or .name == "In Progress") | .id' | head -n 1)
          DONE_ID=$(echo "$STATUSES" | jq -r '.[] | select(.name == "ì™„ë£Œ" or .name == "Done" or .name == "í•´ê²°ë¨" or .name == "ì¢…ë£Œ") | .id' | head -n 1)
          REVIEW_ID=$(echo "$STATUSES" | jq -r '.[] | select((.name | contains("ë¦¬ë·°")) or (.name | contains("Review"))) | .id' | head -n 1)

          echo "ğŸ¯ ë§¤í•‘ëœ ìƒíƒœ:"
          [ -n "$TODO_ID" ] && echo "  ì‹œì‘ ìƒíƒœ: $TODO_ID"
          [ -n "$INPROGRESS_ID" ] && echo "  ì§„í–‰ ì¤‘: $INPROGRESS_ID"
          [ -n "$DONE_ID" ] && echo "  ì™„ë£Œ: $DONE_ID"
          [ -n "$REVIEW_ID" ] && echo "  ë¦¬ë·°: $REVIEW_ID"

          # 4. Workflow Schemeìœ¼ë¡œ ì‹¤ì œ transition ì¡°íšŒ
          echo ""
          echo "ğŸ” Workflow Scheme ì¡°íšŒ ì¤‘..."
          WORKFLOW_SCHEME=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/workflowscheme/project?projectId=$(echo "$PROJECT_INFO" | jq -r .id)")

          # Workflow ì´ë¦„ ì¶”ì¶œ
          WORKFLOW_NAME=$(echo "$WORKFLOW_SCHEME" | jq -r '.issueTypeMappings."'$ISSUE_TYPE_ID'" // .defaultWorkflow')

          echo "âœ… Workflow: $WORKFLOW_NAME"

          # 5. Workflowì˜ transition ì¡°íšŒ
          echo ""
          echo "ğŸ” Transition ëª©ë¡ ì¡°íšŒ ì¤‘..."
          TRANSITIONS_RESPONSE=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/workflow/transitions?workflowName=$(echo "$WORKFLOW_NAME" | jq -R -r @uri)")

          TRANSITIONS=$(echo "$TRANSITIONS_RESPONSE" | jq '[.transitions[] | {id: .id, name: .name, from: .from[], to: .to}]')

          echo "ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ Transition ëª©ë¡:"
          echo "$TRANSITIONS" | jq -r '.[] | "  ID: \(.id) | \(.name) (from: \(.from.name // "Any") â†’ to: \(.to.name))"'

          # Output ì €ì¥
          echo "transitions<<EOF" >> $GITHUB_OUTPUT
          echo "$TRANSITIONS"
          echo "EOF" >> $GITHUB_OUTPUT

          echo "statuses<<EOF" >> $GITHUB_OUTPUT
          echo "$STATUSES"
          echo "EOF" >> $GITHUB_OUTPUT

          echo "sample_issue=N/A" >> $GITHUB_OUTPUT
          echo "workflow_name=$WORKFLOW_NAME" >> $GITHUB_OUTPUT

      - name: Auto-detect transitions if not provided
        id: auto-detect
        run: |
          TRANSITIONS='${{ steps.fetch-transitions.outputs.transitions }}'
          STATUSES='${{ steps.fetch-transitions.outputs.statuses }}'

          START_ID="${{ github.event.inputs.start_transition }}"
          END_ID="${{ github.event.inputs.end_transition }}"
          REVIEW_ID="${{ github.event.inputs.review_transition }}"
          BLOCKED_ID="${{ github.event.inputs.blocked_transition }}"

          echo "ğŸ” Transition ìë™ íƒì§€ ì¤‘..."

          # ì…ë ¥ì´ ì—†ìœ¼ë©´ ìë™ íƒì§€
          if [ -z "$START_ID" ]; then
            # "In Progress"ë¡œ ê°€ëŠ” transition ì°¾ê¸°
            START_ID=$(echo "$TRANSITIONS" | jq -r '.[] | select(
              (.to.name | ascii_downcase) == "in progress" or
              (.to.name | ascii_downcase) == "ì§„í–‰ ì¤‘" or
              (.to.name | ascii_downcase) == "ì§„í–‰ì¤‘" or
              (.to.id == "'$(echo "$STATUSES" | jq -r '.[] | select(.name == "ì§„í–‰ ì¤‘" or .name == "In Progress") | .id' | head -n 1)'")
            ) | .id' | head -n 1)

            if [ -n "$START_ID" ] && [ "$START_ID" != "null" ] && [ "$START_ID" != "" ]; then
              START_NAME=$(echo "$TRANSITIONS" | jq -r ".[] | select(.id == \"$START_ID\") | .to.name")
              echo "âœ… ì‘ì—… ì‹œì‘: ID=$START_ID â†’ $START_NAME"
            else
              echo "âš ï¸  ì‘ì—… ì‹œì‘ transitionì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            fi
          fi

          if [ -z "$END_ID" ]; then
            # "Done"ìœ¼ë¡œ ê°€ëŠ” transition ì°¾ê¸°
            END_ID=$(echo "$TRANSITIONS" | jq -r '.[] | select(
              (.to.name | ascii_downcase) == "done" or
              (.to.name | ascii_downcase) == "ì™„ë£Œ" or
              (.to.name | ascii_downcase) == "í•´ê²°ë¨" or
              (.to.name | ascii_downcase) == "ì¢…ë£Œ" or
              (.to.id == "'$(echo "$STATUSES" | jq -r '.[] | select(.name == "ì™„ë£Œ" or .name == "Done" or .name == "í•´ê²°ë¨" or .name == "ì¢…ë£Œ") | .id' | head -n 1)'")
            ) | .id' | head -n 1)

            if [ -n "$END_ID" ] && [ "$END_ID" != "null" ] && [ "$END_ID" != "" ]; then
              END_NAME=$(echo "$TRANSITIONS" | jq -r ".[] | select(.id == \"$END_ID\") | .to.name")
              echo "âœ… ì‘ì—… ì™„ë£Œ: ID=$END_ID â†’ $END_NAME"
            else
              echo "âš ï¸  ì‘ì—… ì™„ë£Œ transitionì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            fi
          fi

          if [ -z "$REVIEW_ID" ]; then
            REVIEW_ID=$(echo "$TRANSITIONS" | jq -r '.[] | select(
              (.to.name | ascii_downcase) | contains("review") or
              (.to.name | ascii_downcase) | contains("ë¦¬ë·°")
            ) | .id' | head -n 1)

            if [ -n "$REVIEW_ID" ] && [ "$REVIEW_ID" != "null" ] && [ "$REVIEW_ID" != "" ]; then
              REVIEW_NAME=$(echo "$TRANSITIONS" | jq -r ".[] | select(.id == \"$REVIEW_ID\") | .to.name")
              echo "âœ… ë¦¬ë·°: ID=$REVIEW_ID â†’ $REVIEW_NAME"
            fi
          fi

          if [ -z "$BLOCKED_ID" ]; then
            BLOCKED_ID=$(echo "$TRANSITIONS" | jq -r '.[] | select(
              (.to.name | ascii_downcase) | contains("block") or
              (.to.name | ascii_downcase) | contains("ë¸”ë¡œí‚¹")
            ) | .id' | head -n 1)

            if [ -n "$BLOCKED_ID" ] && [ "$BLOCKED_ID" != "null" ] && [ "$BLOCKED_ID" != "" ]; then
              BLOCKED_NAME=$(echo "$TRANSITIONS" | jq -r ".[] | select(.id == \"$BLOCKED_ID\") | .to.name")
              echo "âœ… ë¸”ë¡œí‚¹: ID=$BLOCKED_ID â†’ $BLOCKED_NAME"
            fi
          fi

          echo "start_id=$START_ID" >> $GITHUB_OUTPUT
          echo "end_id=$END_ID" >> $GITHUB_OUTPUT
          echo "review_id=$REVIEW_ID" >> $GITHUB_OUTPUT
          echo "blocked_id=$BLOCKED_ID" >> $GITHUB_OUTPUT

      - name: Create workflow config file
        run: |
          SAMPLE_ISSUE="${{ steps.fetch-transitions.outputs.sample_issue }}"
          PROJECT_KEY="${{ secrets.JIRA_PROJECT }}"
          TRANSITIONS='${{ steps.fetch-transitions.outputs.transitions }}'
          START_ID="${{ steps.auto-detect.outputs.start_id }}"
          END_ID="${{ steps.auto-detect.outputs.end_id }}"
          REVIEW_ID="${{ steps.auto-detect.outputs.review_id }}"
          BLOCKED_ID="${{ steps.auto-detect.outputs.blocked_id }}"

          # null ê°’ ì²˜ë¦¬
          [ "$START_ID" = "null" ] && START_ID=""
          [ "$END_ID" = "null" ] && END_ID=""
          [ "$REVIEW_ID" = "null" ] && REVIEW_ID=""
          [ "$BLOCKED_ID" = "null" ] && BLOCKED_ID=""

          cat > scripts/jira/jira-workflow-config.json << EOF
          {
            "lastUpdated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "projectKey": "$PROJECT_KEY",
            "sampleIssue": "$SAMPLE_ISSUE",
            "jiraBaseUrl": "${{ secrets.JIRA_BASE_URL }}",
            "transitions": $(echo "$TRANSITIONS" | jq 'map({
              id: .id,
              name: .name,
              toStatus: .to.name,
              toStatusId: .to.id
            })'),
            "mappings": {
              "start": $([ -n "$START_ID" ] && echo "\"$START_ID\"" || echo "null"),
              "end": $([ -n "$END_ID" ] && echo "\"$END_ID\"" || echo "null"),
              "inProgress": $([ -n "$START_ID" ] && echo "\"$START_ID\"" || echo "null"),
              "review": $([ -n "$REVIEW_ID" ] && echo "\"$REVIEW_ID\"" || echo "null"),
              "blocked": $([ -n "$BLOCKED_ID" ] && echo "\"$BLOCKED_ID\"" || echo "null")
            }
          }
          EOF

          echo "âœ… ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ"
          echo ""
          echo "ğŸ“„ ì €ì¥ëœ ì„¤ì •:"
          cat scripts/jira/jira-workflow-config.json | jq '.'

      - name: Commit and push config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add scripts/jira/jira-workflow-config.json

          if git diff --cached --quiet; then
            echo "âš ï¸  ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          else
            COMMIT_MSG=$(cat <<EOF
          chore: Update Jira workflow configuration

          Project: ${{ secrets.JIRA_PROJECT }}
          Sample issue: ${{ steps.fetch-transitions.outputs.sample_issue }}

          Configured transitions:
          - Start: ${{ steps.auto-detect.outputs.start_id }}
          - End: ${{ steps.auto-detect.outputs.end_id }}
          - Review: ${{ steps.auto-detect.outputs.review_id }}
          - Blocked: ${{ steps.auto-detect.outputs.blocked_id }}
          EOF
          )
            
            git commit -m "$COMMIT_MSG"
            git push
            echo "âœ… ì„¤ì • íŒŒì¼ì´ ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤!"
          fi

      - name: Create summary comment
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-issue"
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "âœ… Jira Workflow ì„¤ì • ì™„ë£Œ"
          body: |
            ## ğŸ‰ Jira Workflow ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!

            **í”„ë¡œì íŠ¸**: ${{ secrets.JIRA_PROJECT }}
            **ìƒ˜í”Œ ì´ìŠˆ**: ${{ steps.fetch-transitions.outputs.sample_issue }}
            **ì„¤ì • ì‹œê°„**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

            ### ğŸ“‹ ì„¤ì •ëœ Transition

            | ì•¡ì…˜ | Transition ID | ìƒíƒœ |
            |------|--------------|------|
            | ì‘ì—… ì‹œì‘ | `${{ steps.auto-detect.outputs.start_id }}` | ${{ steps.auto-detect.outputs.start_id != '' && 'âœ…' || 'âš ï¸ ë¯¸ì„¤ì •' }} |
            | ì‘ì—… ì™„ë£Œ | `${{ steps.auto-detect.outputs.end_id }}` | ${{ steps.auto-detect.outputs.end_id != '' && 'âœ…' || 'âš ï¸ ë¯¸ì„¤ì •' }} |
            | ë¦¬ë·° | `${{ steps.auto-detect.outputs.review_id }}` | ${{ steps.auto-detect.outputs.review_id != '' && 'âœ…' || 'âš ï¸ ë¯¸ì„¤ì •' }} |
            | ë¸”ë¡œí‚¹ | `${{ steps.auto-detect.outputs.blocked_id }}` | ${{ steps.auto-detect.outputs.blocked_id != '' && 'âœ…' || 'âš ï¸ ë¯¸ì„¤ì •' }} |

            ### ğŸ“– ì‚¬ìš© ê°€ëŠ¥í•œ Transition ëª©ë¡

            ```json
            ${{ steps.fetch-transitions.outputs.transitions }}
            ```

            ### ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„

            - ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”
            - `npm run issue:start`, `npm run issue:end` ëª…ë ¹ì–´ê°€ ì´ì œ ì´ ì„¤ì •ì„ ì‚¬ìš©í•©ë‹ˆë‹¤
            - ìˆ˜ì •ì´ í•„ìš”í•˜ë©´ Actions íƒ­ì—ì„œ "Setup Jira Workflow"ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”

            **ì„¤ì • íŒŒì¼**: `scripts/jira/jira-workflow-config.json`
          labels: "jira,automation,config"
