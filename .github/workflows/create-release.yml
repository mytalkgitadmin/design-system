name: Create Release

on:
  workflow_dispatch:
    inputs:
      version_override:
        description: 'ë²„ì „ ì§€ì • (ë¹„ì›Œë‘ë©´ package.json ì‚¬ìš©)'
        required: false
        type: string
        default: ''
      release_notes:
        description: 'ì¶”ê°€ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸'
        required: false
        type: string
        default: ''
      prerelease:
        description: 'í”„ë¦¬ë¦´ë¦¬ì¦ˆ ì—¬ë¶€'
        required: false
        type: boolean
        default: false

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ í•„ìš” (ì´ì „ íƒœê·¸ ì¡°íšŒìš©)

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '23.11.0'

      - name: Get version
        id: version
        run: |
          if [ -n "${{ inputs.version_override }}" ]; then
            VERSION="${{ inputs.version_override }}"
            echo "ðŸ“ ìˆ˜ë™ ì§€ì •ëœ ë²„ì „ ì‚¬ìš©: $VERSION"
          else
            VERSION=$(node -p "require('./package.json').version")
            echo "ðŸ“¦ package.json ë²„ì „ ì‚¬ìš©: $VERSION"
          fi
          
          # v ì ‘ë‘ì‚¬ ì¶”ê°€
          if [[ ! "$VERSION" =~ ^v ]]; then
            VERSION="v${VERSION}"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_without_v=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸  ë¦´ë¦¬ì¦ˆ ë²„ì „: $VERSION"

      - name: Check if tag exists
        id: check_tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  íƒœê·¸ $VERSION ì´(ê°€) ì´ë¯¸ ì¡´ìž¬í•©ë‹ˆë‹¤!"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… íƒœê·¸ $VERSION ìƒì„± ê°€ëŠ¥"
          fi

      - name: Create Git tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"
          echo "âœ… Git íƒœê·¸ ìƒì„± ì™„ë£Œ: $VERSION"

      - name: Get previous tag
        id: previous_tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^${VERSION}$" | head -n 1)
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "previous_tag=" >> $GITHUB_OUTPUT
            echo "ðŸ“ ì´ì „ íƒœê·¸ ì—†ìŒ (ì²« ë¦´ë¦¬ì¦ˆ)"
          else
            echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
            echo "ðŸ“ ì´ì „ íƒœê·¸: $PREVIOUS_TAG"
          fi

      - name: Extract Jira tickets from commits
        id: jira_tickets
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PREVIOUS_TAG="${{ steps.previous_tag.outputs.previous_tag }}"
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # ì²« ë¦´ë¦¬ì¦ˆ: ëª¨ë“  ì»¤ë°‹
            COMMITS=$(git log --pretty=format:"%s %b")
          else
            # ì´ì „ íƒœê·¸ë¶€í„° í˜„ìž¬ê¹Œì§€
            COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s %b")
          fi
          
          # Jira í‹°ì¼“ ì¶”ì¶œ (PROJ-123 íŒ¨í„´)
          TICKETS=$(echo "$COMMITS" | grep -oE '\b[A-Z]+-[0-9]+\b' | sort -u | tr '\n' ',' | sed 's/,$//')
          
          if [ -z "$TICKETS" ]; then
            echo "tickets=" >> $GITHUB_OUTPUT
            echo "ðŸ“ Jira í‹°ì¼“ ì—†ìŒ"
          else
            echo "tickets=$TICKETS" >> $GITHUB_OUTPUT
            echo "ðŸ“ ì¶”ì¶œëœ Jira í‹°ì¼“: $TICKETS"
          fi

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: Release ${{ steps.version.outputs.version }}
          body: |
            ## ðŸŽ‰ Release ${{ steps.version.outputs.version }}
            
            ${{ inputs.release_notes }}
            
            ### ðŸ“¦ ë°°í¬ ì •ë³´
            - **ë²„ì „**: ${{ steps.version.outputs.version }}
            - **Nexus Registry**: npm-bemily
            - **Package**: @bemily/design-system@${{ steps.version.outputs.version_without_v }}
            
            ### ðŸ“ ì„¤ì¹˜ ë°©ë²•
            ```bash
            npm install @bemily/design-system@${{ steps.version.outputs.version_without_v }}
            # ë˜ëŠ”
            npm update @bemily/design-system
            ```
            
            ### ðŸ”— ê´€ë ¨ ë§í¬
            - [Nexus Repository](https://nexus.danalentertainment.com/#browse/browse:npm-bemily)
            - [Jira Release](https://jira.danalentertainment.com/projects/${{ secrets.JIRA_PROJECT }}/versions)
            
            ---
            _ì´ ë¦´ë¦¬ì¦ˆëŠ” GitHub Actionsì— ì˜í•´ ìžë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤._
          draft: false
          prerelease: ${{ inputs.prerelease }}

      - name: Create Jira Release
        if: steps.jira_tickets.outputs.tickets != ''
        run: node scripts/jira/create-release.js
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT: ${{ secrets.JIRA_PROJECT }}
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
          JIRA_TICKETS: ${{ steps.jira_tickets.outputs.tickets }}
          GITHUB_RELEASE_URL: ${{ steps.create_release.outputs.html_url }}

      - name: Summary
        if: always()
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TICKETS="${{ steps.jira_tickets.outputs.tickets }}"
          
          echo "## ðŸŽ‰ ë¦´ë¦¬ì¦ˆ ìƒì„± ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ë¦´ë¦¬ì¦ˆ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ë‚´ìš© |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ·ï¸ ë²„ì „ | $VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ íŒ¨í‚¤ì§€ | @bemily/design-system |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— GitHub Release | [$VERSION](${{ steps.create_release.outputs.html_url }}) |" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$TICKETS" ]; then
            TICKET_COUNT=$(echo "$TICKETS" | tr ',' '\n' | wc -l)
            echo "| ðŸŽ« Jira í‹°ì¼“ | ${TICKET_COUNT}ê°œ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸŽ« Jira í‹°ì¼“ | ì—†ìŒ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… ì™„ë£Œëœ ìž‘ì—…" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Git íƒœê·¸ ìƒì„±" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Release ìƒì„±" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ì†ŒìŠ¤ì½”ë“œ ì•„ì¹´ì´ë¸Œ (zip, tar.gz)" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$TICKETS" ]; then
            echo "- âœ… Jira Release ìƒì„± ë° í‹°ì¼“ ì—°ê²°" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ì„¤ì¹˜ ë°©ë²•" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "npm install @bemily/design-system@${{ steps.version.outputs.version_without_v }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

