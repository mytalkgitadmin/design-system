name: Create PR (Interactive)

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: "Source ë¸Œëžœì¹˜ (ì˜ˆ: AUDS-60-test)"
        required: true
        type: string
      target_branch:
        description: "Target ë¸Œëžœì¹˜ (ì˜ˆ: pre_dev)"
        required: false
        default: "pre_dev"
        type: string
      pr_title:
        description: "PR ì œëª©"
        required: true
        type: string
      pr_body:
        description: "PR ë³¸ë¬¸ (ì„ íƒì‚¬í•­)"
        required: false
        type: string
      jira_ticket:
        description: "Jira í‹°ì¼“ (ì˜ˆ: AUDS-60, ì„ íƒì‚¬í•­)"
        required: false
        type: string
      issue_number:
        description: "ë‹«ì„ GitHub Issue ë²ˆí˜¸ (ì„ íƒì‚¬í•­)"
        required: false
        type: string
      draft:
        description: "Draft PRë¡œ ìƒì„±"
        required: false
        type: boolean
        default: false

jobs:
  create-pr:
    name: Create Pull Request
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Pull Request
        id: create-pr
        run: |
          SOURCE_BRANCH="${{ inputs.source_branch }}"
          TARGET_BRANCH="${{ inputs.target_branch }}"
          PR_TITLE="${{ inputs.pr_title }}"
          JIRA_TICKET="${{ inputs.jira_ticket }}"
          ISSUE_NUMBER="${{ inputs.issue_number }}"
          DRAFT="${{ inputs.draft }}"

          echo "ðŸ”€ Pull Request ìƒì„± ì¤‘..."
          echo "  Source: ${SOURCE_BRANCH}"
          echo "  Target: ${TARGET_BRANCH}"
          echo "  Title: ${PR_TITLE}"

          # PR ë³¸ë¬¸ ìƒì„±
          PR_BODY="${{ inputs.pr_body }}"
          
          # PR ë³¸ë¬¸ì´ ë¹„ì–´ìžˆìœ¼ë©´ ê¸°ë³¸ í…œí”Œë¦¿ ì‚¬ìš©
          if [ -z "$PR_BODY" ]; then
            PR_BODY="## ðŸ“‹ ìž‘ì—… ë‚´ìš©

"
            
            # Issue ë²ˆí˜¸ê°€ ìžˆìœ¼ë©´ ì¶”ê°€
            if [ -n "$ISSUE_NUMBER" ]; then
              PR_BODY="${PR_BODY}
closes #${ISSUE_NUMBER}
"
            fi
            
            # Jira í‹°ì¼“ì´ ìžˆìœ¼ë©´ ì¶”ê°€
            if [ -n "$JIRA_TICKET" ]; then
              PR_BODY="${PR_BODY}
### ðŸŽ« ê´€ë ¨ Jira í‹°ì¼“
[${{ inputs.jira_ticket }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ inputs.jira_ticket }})
"
            fi
            
            PR_BODY="${PR_BODY}
### ðŸ‘¤ ìž‘ì—…ìž
${{ github.actor }}

---
ì´ PRì€ ìˆ˜ë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          fi

          # Draft ì˜µì…˜ ì²˜ë¦¬
          DRAFT_FLAG=""
          if [ "$DRAFT" = "true" ]; then
            DRAFT_FLAG="--draft"
          fi

          # PR ìƒì„±
          PR_URL=$(gh pr create \
            --base "${TARGET_BRANCH}" \
            --head "${SOURCE_BRANCH}" \
            --title "${PR_TITLE}" \
            --body "${PR_BODY}" \
            ${DRAFT_FLAG})

          echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
          echo "âœ… Pull Request ìƒì„± ì™„ë£Œ"
          echo "ðŸ”— ${PR_URL}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Close GitHub Issue (if specified)
        if: inputs.issue_number != ''
        run: |
          PR_URL="${{ steps.create-pr.outputs.pr_url }}"
          ISSUE_NUMBER="${{ inputs.issue_number }}"

          echo "ðŸ”’ GitHub Issue #${ISSUE_NUMBER} ë‹«ëŠ” ì¤‘..."

          CLOSE_COMMENT="âœ… ìž‘ì—…ì´ ì™„ë£Œë˜ì–´ Issueê°€ ë‹«í˜”ìŠµë‹ˆë‹¤.

ðŸ”€ Pull Request: ${PR_URL}"

          gh issue close ${ISSUE_NUMBER} --comment "${CLOSE_COMMENT}"

          echo "âœ… Issue ë‹«ê¸° ì™„ë£Œ"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## âœ… PR ìƒì„± ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|:---|:---|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— **PR URL** | ${{ steps.create-pr.outputs.pr_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ **Source Branch** | \`${{ inputs.source_branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ **Target Branch** | \`${{ inputs.target_branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ **Title** | ${{ inputs.pr_title }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ inputs.jira_ticket }}" ]; then
            echo "| ðŸŽ« **Jira Ticket** | [${{ inputs.jira_ticket }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ inputs.jira_ticket }}) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ inputs.issue_number }}" ]; then
            echo "| ðŸ”’ **Closed Issue** | #${{ inputs.issue_number }} |" >> $GITHUB_STEP_SUMMARY
          fi

