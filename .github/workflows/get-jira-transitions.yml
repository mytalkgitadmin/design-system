name: Get Jira Transitions

on:
  workflow_dispatch:
    inputs:
      issue_key:
        description: "Jira Issue Key (ì˜ˆ: AUDS-123)"
        required: true
        type: string

jobs:
  get-transitions:
    runs-on: ubuntu-latest

    steps:
      - name: Get Jira Transitions
        run: |
          ISSUE_KEY="${{ inputs.issue_key }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” $ISSUE_KEY ì˜ ì‚¬ìš© ê°€ëŠ¥í•œ Transitions ì¡°íšŒ ì¤‘..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # í˜„ìž¬ ìƒíƒœ í™•ì¸
          ISSUE_RESPONSE=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/$ISSUE_KEY")

          CURRENT_STATUS=$(echo "$ISSUE_RESPONSE" | jq -r '.fields.status.name // empty')

          if [ -z "$CURRENT_STATUS" ]; then
            echo "âŒ Issueë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: $ISSUE_KEY"
            echo ""
            echo "ì‘ë‹µ:"
            echo "$ISSUE_RESPONSE" | jq '.'
            exit 1
          fi

          echo "ðŸ“Œ í˜„ìž¬ ìƒíƒœ: $CURRENT_STATUS"
          echo ""

          # Transitions ì¡°íšŒ
          TRANSITIONS_RESPONSE=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/$ISSUE_KEY/transitions")

          TRANSITION_COUNT=$(echo "$TRANSITIONS_RESPONSE" | jq '.transitions | length')

          if [ "$TRANSITION_COUNT" -eq 0 ]; then
            echo "âš ï¸  í˜„ìž¬ ìƒíƒœì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ transitionì´ ì—†ìŠµë‹ˆë‹¤."
            exit 0
          fi

          echo "âœ… ì‚¬ìš© ê°€ëŠ¥í•œ Transitions:"
          echo ""

          # JSON íŒŒì‹± ë° í¬ë§·íŒ…
          echo "$TRANSITIONS_RESPONSE" | jq -r '.transitions[] | "  ID: \(.id) | \(.name) â†’ \(.to.name)"'

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ’¡ ì„¤ì • ë°©ë²•:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "scripts/jira/jira-workflow-config.json íŒŒì¼ì— ì•„ëž˜ì™€ ê°™ì´ ìž…ë ¥:"
          echo ""
          echo '{'
          echo '  "mappings": {'
          echo '    "init": "?",     â† (ì„ íƒ) ì´ˆê¸° ìƒíƒœ ID'
          echo '    "start": "?",    â† ìœ„ì—ì„œ "ì§„í–‰ ì¤‘"ìœ¼ë¡œ ê°€ëŠ” ID'
          echo '    "end": "?"        â† ìœ„ì—ì„œ "ì™„ë£Œ"ë¡œ ê°€ëŠ” ID'
          echo '  }'
          echo '}'
          echo ""
          echo "ì˜ˆì‹œ:"
          echo '  "init": "1"       â† ID: 1  | Create â†’ í•´ì•¼ í•  ì¼'
          echo '  "start": "21"     â† ID: 21 | Start Progress â†’ ì§„í–‰ ì¤‘'
          echo '  "end": "31"       â† ID: 31 | Done â†’ ì™„ë£Œ'
          echo ""

          # Summary ìƒì„±
          echo "## ðŸ” Jira Transitions ì¡°íšŒ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Issue:** \`$ISSUE_KEY\`" >> $GITHUB_STEP_SUMMARY
          echo "**í˜„ìž¬ ìƒíƒœ:** $CURRENT_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… ì‚¬ìš© ê°€ëŠ¥í•œ Transitions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ID | Transition Name | Target Status |" >> $GITHUB_STEP_SUMMARY
          echo "|:---|:----------------|:--------------|" >> $GITHUB_STEP_SUMMARY

          echo "$TRANSITIONS_RESPONSE" | jq -r '.transitions[] | "| `\(.id)` | \(.name) | **\(.to.name)** |"' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ ì„¤ì • ë°©ë²•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`scripts/jira/jira-workflow-config.json\` íŒŒì¼ì— ë‹¤ìŒê³¼ ê°™ì´ ìž…ë ¥í•˜ì„¸ìš”:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '{' >> $GITHUB_STEP_SUMMARY
          echo '  "mappings": {' >> $GITHUB_STEP_SUMMARY
          echo '    "init": "ì´ˆê¸°_ìƒíƒœ_ID",      â† (ì„ íƒ) Issue ìƒì„± ì‹œ ì´ˆê¸° ìƒíƒœ' >> $GITHUB_STEP_SUMMARY
          echo '    "start": "ìž‘ì—…_ì‹œìž‘_ID",     â† "ì§„í–‰ ì¤‘"ìœ¼ë¡œ ê°€ëŠ” ID' >> $GITHUB_STEP_SUMMARY
          echo '    "end": "ìž‘ì—…_ì™„ë£Œ_ID"         â† "ì™„ë£Œ"ë¡œ ê°€ëŠ” ID' >> $GITHUB_STEP_SUMMARY
          echo '  }' >> $GITHUB_STEP_SUMMARY
          echo '}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**í•„ìˆ˜ ID:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`init\`: (ì„ íƒ) Issue ìƒì„± ì‹œ ì´ˆê¸° ìƒíƒœ Transition ID" >> $GITHUB_STEP_SUMMARY
          echo "- \`start\`: \"í•´ì•¼ í•  ì¼\" â†’ \"ì§„í–‰ ì¤‘\" ìœ¼ë¡œ ê°€ëŠ” Transition ID" >> $GITHUB_STEP_SUMMARY
          echo "- \`end\`: \"ì§„í–‰ ì¤‘\" â†’ \"ì™„ë£Œ\" ë˜ëŠ” \"í•´ê²°ë¨\"ìœ¼ë¡œ ê°€ëŠ” Transition ID" >> $GITHUB_STEP_SUMMARY
