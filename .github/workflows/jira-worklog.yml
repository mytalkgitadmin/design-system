name: Jira Work Log Management

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      action:
        description: "Work action (start or end)"
        required: true
        type: choice
        options:
          - start
          - end
      issue_number:
        description: "GitHub Issue number"
        required: true
        type: string

jobs:
  manage-worklog:
    name: Manage Jira Work Log
    runs-on: ubuntu-latest
    # "work:start" ë˜ëŠ” "work:end" ë¼ë²¨ì´ ì¶”ê°€ë˜ê±°ë‚˜, íŠ¹ì • ì½”ë©˜íŠ¸ê°€ ë‹¬ë ¸ì„ ë•Œë§Œ ì‹¤í–‰
    if: |
      (github.event_name == 'issues' && (contains(github.event.label.name, 'work:start') || contains(github.event.label.name, 'work:end'))) ||
      (github.event_name == 'issue_comment' && (startsWith(github.event.comment.body, '/work-start') || startsWith(github.event.comment.body, '/work-end')))

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ (config íŒŒì¼ ì½ê¸° ìœ„í•¨)
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Jira í‹°ì¼“ ì¶”ì¶œ
      - name: Extract Jira ticket
        id: extract-ticket
        run: |
          # ì œëª©ì—ì„œ [JIRA-123] í˜•ì‹ìœ¼ë¡œ ì¶”ì¶œ
          JIRA_TICKET=$(echo '${{ github.event.issue.title }}' | grep -oE '\[([A-Z]+-[0-9]+)\]' | tr -d '[]' | head -n 1)

          # ì œëª©ì— ì—†ìœ¼ë©´ ë³¸ë¬¸ì—ì„œ ì¶”ì¶œ
          if [ -z "$JIRA_TICKET" ]; then
            JIRA_TICKET=$(echo '${{ github.event.issue.body }}' | grep -oE '([A-Z]+-[0-9]+)' | head -n 1)
          fi

          if [ -z "$JIRA_TICKET" ]; then
            echo "âš ï¸  Jira í‹°ì¼“ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "jira_ticket=$JIRA_TICKET" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "âœ… Jira í‹°ì¼“: $JIRA_TICKET"

      # 3. ìž‘ì—… íƒ€ìž… ê²°ì • (ì‹œìž‘ or ì¢…ë£Œ)
      - name: Determine work action
        id: work-action
        run: |
          if [ "${{ github.event_name }}" = "issues" ]; then
            LABEL="${{ github.event.label.name }}"
            if [ "$LABEL" = "work:start" ]; then
              echo "action=start" >> $GITHUB_OUTPUT
            elif [ "$LABEL" = "work:end" ]; then
              echo "action=end" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT="${{ github.event.comment.body }}"
            if echo "$COMMENT" | grep -q "^/work-start"; then
              echo "action=start" >> $GITHUB_OUTPUT
            elif echo "$COMMENT" | grep -q "^/work-end"; then
              echo "action=end" >> $GITHUB_OUTPUT
            fi
          fi

          echo "âœ… ìž‘ì—… íƒ€ìž…: $(cat $GITHUB_OUTPUT | grep action | cut -d= -f2)"

      # 4-A. ìž‘ì—… ì‹œìž‘ - Work Log ê¸°ë¡
      - name: Start work - Add work log
        if: steps.work-action.outputs.action == 'start' && steps.extract-ticket.outputs.skip != 'true'
        id: start-work
        run: |
          JIRA_TICKET="${{ steps.extract-ticket.outputs.jira_ticket }}"
          START_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.000+0000")

          echo "ðŸš€ ìž‘ì—… ì‹œìž‘ ì²˜ë¦¬ ì¤‘..."

          # Work Log ì¶”ê°€ (1ì´ˆë§Œ ê¸°ë¡)
          echo "ðŸ“ Work Log ê¸°ë¡ ì¤‘..."
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{
              \"comment\": \"ðŸš€ ìž‘ì—… ì‹œìž‘\\n\\nðŸ“Œ By: ${{ github.actor }}\\nðŸ”— GitHub Issue: ${{ github.event.issue.html_url }}\",
              \"started\": \"${START_TIME}\",
              \"timeSpentSeconds\": 1
            }" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/worklog" > /dev/null

          echo "âœ… Work Log ê¸°ë¡ ì™„ë£Œ"

          # Start date ì„¤ì •
          echo ""
          echo "ðŸ“… Start date ì„¤ì • ì¤‘..."
          START_DATE=$(date -u +"%Y-%m-%d")
          curl -s -X PUT \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{\"fields\": {\"customfield_10015\": \"${START_DATE}\"}}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}" > /dev/null

          echo "âœ… Start date ì„¤ì • ì™„ë£Œ"
          echo ""
          echo "start_time=${START_TIME}" >> $GITHUB_OUTPUT
          echo "ðŸŽ‰ ìž‘ì—… ì‹œìž‘ ì™„ë£Œ!"

      # 4-B. ìž‘ì—… ì¢…ë£Œ - Work Log ê¸°ë¡
      - name: End work - Add work log
        if: steps.work-action.outputs.action == 'end' && steps.extract-ticket.outputs.skip != 'true'
        id: end-work
        run: |
          JIRA_TICKET="${{ steps.extract-ticket.outputs.jira_ticket }}"
          END_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.000+0000")

          echo "âœ… ìž‘ì—… ì¢…ë£Œ ì²˜ë¦¬ ì¤‘..."

          # 1. ìž‘ì—… ì‹œê°„ ê³„ì‚° (GitHub Issue ìƒì„±/ë¼ë²¨ë§ ì‹œê°„ ê¸°ì¤€)
          # GitHub APIë¡œ "work:start" ë¼ë²¨ì´ ì¶”ê°€ëœ ì‹œê°„ ì¡°íšŒ
          EVENTS=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/events")

          START_TIME_RAW=$(echo "$EVENTS" | jq -r '.[] | select(.event == "labeled" and .label.name == "work:start") | .created_at' | head -n 1)

          if [ -z "$START_TIME_RAW" ] || [ "$START_TIME_RAW" = "null" ]; then
            echo "âš ï¸  ìž‘ì—… ì‹œìž‘ ì‹œê°„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’(1ì‹œê°„) ì‚¬ìš©"
            WORK_SECONDS=3600
            # Linuxì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ -d ì˜µì…˜ ì‚¬ìš©
            START_TIME=$(date -u -d '1 hour ago' +"%Y-%m-%dT%H:%M:%S.000+0000")
          else
            # GitHub ActionsëŠ” Linuxì—ì„œ ì‹¤í–‰ (Ubuntu)
            START_EPOCH=$(date -d "$START_TIME_RAW" +%s)
            END_EPOCH=$(date +%s)
            WORK_SECONDS=$((END_EPOCH - START_EPOCH))
            
            # ìµœì†Œ 60ì´ˆ ë³´ìž¥
            if [ $WORK_SECONDS -lt 60 ]; then
              WORK_SECONDS=60
            fi
            
            # GitHub ISO 8601 í˜•ì‹ì„ Jira í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (2025-12-17T04:17:44Z â†’ 2025-12-17T04:17:44.000+0000)
            START_TIME=$(date -u -d "$START_TIME_RAW" +"%Y-%m-%dT%H:%M:%S.000+0000")
          fi

          WORK_HOURS=$((WORK_SECONDS / 3600))
          WORK_MINUTES=$(((WORK_SECONDS % 3600) / 60))

          echo "â±ï¸  ìž‘ì—… ì‹œê°„: ${WORK_HOURS}ì‹œê°„ ${WORK_MINUTES}ë¶„ (${WORK_SECONDS}ì´ˆ)"

          # 2. Work Log ì¶”ê°€
          echo "ðŸ“ Work Log ìš”ì²­ ë°ì´í„°:"
          echo "  - Started: ${START_TIME}"
          echo "  - Time Spent: ${WORK_SECONDS}ì´ˆ (${WORK_HOURS}h ${WORK_MINUTES}m)"

          WORKLOG_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{
              \"comment\": \"âœ… ìž‘ì—… ì™„ë£Œ\\n\\nâ±ï¸  ìž‘ì—… ì‹œê°„: ${WORK_HOURS}ì‹œê°„ ${WORK_MINUTES}ë¶„\\nðŸ“Œ By: ${{ github.actor }}\\nðŸ”— GitHub Issue: ${{ github.event.issue.html_url }}\",
              \"started\": \"${START_TIME}\",
              \"timeSpentSeconds\": ${WORK_SECONDS}
            }" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/worklog")

          HTTP_CODE=$(echo "$WORKLOG_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$WORKLOG_RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Work Log ì¶”ê°€ ì™„ë£Œ (HTTP $HTTP_CODE)"
          else
            echo "âŒ Work Log ì¶”ê°€ ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
            echo "ì‘ë‹µ: $RESPONSE_BODY"
          fi

          echo "work_time=${WORK_HOURS}ì‹œê°„ ${WORK_MINUTES}ë¶„" >> $GITHUB_OUTPUT

      # 4-C. PR Config ë¡œë“œ ë° ë¸Œëžœì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      - name: Load PR config and get branch info
        if: steps.work-action.outputs.action == 'end' && steps.extract-ticket.outputs.skip != 'true'
        id: pr-config
        run: |
          JIRA_TICKET="${{ steps.extract-ticket.outputs.jira_ticket }}"

          # PR Config íŒŒì¼ ë¡œë“œ
          if [ -f "scripts/jira/pr-config.json" ]; then
            TARGET_BRANCH=$(jq -r '.target_branch // "pre_dev"' scripts/jira/pr-config.json)
            AUTO_CREATE=$(jq -r '.auto_create_pr // true' scripts/jira/pr-config.json)
            DRAFT=$(jq -r '.pr_template.draft // false' scripts/jira/pr-config.json)
            
            echo "target_branch=${TARGET_BRANCH}" >> $GITHUB_OUTPUT
            echo "auto_create=${AUTO_CREATE}" >> $GITHUB_OUTPUT
            echo "draft=${DRAFT}" >> $GITHUB_OUTPUT
            
            echo "âœ… PR Config ë¡œë“œ ì™„ë£Œ"
            echo "  Target Branch: ${TARGET_BRANCH}"
            echo "  Auto Create: ${AUTO_CREATE}"
          else
            echo "âš ï¸  PR Config íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ ì‚¬ìš© (pre_dev)"
            echo "target_branch=pre_dev" >> $GITHUB_OUTPUT
            echo "auto_create=true" >> $GITHUB_OUTPUT
            echo "draft=false" >> $GITHUB_OUTPUT
          fi

          # í˜„ìž¬ ë¸Œëžœì¹˜ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (Issueì™€ ì—°ê²°ëœ ë¸Œëžœì¹˜)
          # GitHub APIë¡œ Issueì™€ ì—°ê²°ëœ ë¸Œëžœì¹˜ ì°¾ê¸°
          LINKED_BRANCHES=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/timeline" \
            | jq -r '.[] | select(.event == "cross-referenced" and .source.type == "issue") | .source.issue.pull_request.head.ref // empty' | head -n 1)

          # ì—°ê²°ëœ ë¸Œëžœì¹˜ê°€ ì—†ìœ¼ë©´ Issue ë²ˆí˜¸ë¡œ ë¸Œëžœì¹˜ ê²€ìƒ‰
          if [ -z "$LINKED_BRANCHES" ]; then
            # feature/JIRA-123 ë˜ëŠ” JIRA-123 í˜•íƒœì˜ ë¸Œëžœì¹˜ ì°¾ê¸°
            POSSIBLE_BRANCHES=$(gh api \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/branches" \
              | jq -r '.[].name' \
              | grep -i "${JIRA_TICKET}" \
              | head -n 1)
            
            if [ -n "$POSSIBLE_BRANCHES" ]; then
              echo "source_branch=${POSSIBLE_BRANCHES}" >> $GITHUB_OUTPUT
              echo "âœ… ë¸Œëžœì¹˜ ë°œê²¬: ${POSSIBLE_BRANCHES}"
            else
              echo "âš ï¸  ì—°ê²°ëœ ë¸Œëžœì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "skip_pr=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            echo "source_branch=${LINKED_BRANCHES}" >> $GITHUB_OUTPUT
            echo "âœ… ì—°ê²°ëœ ë¸Œëžœì¹˜ ë°œê²¬: ${LINKED_BRANCHES}"
          fi

          echo "skip_pr=false" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 4-D. Pull Request ìƒì„±
      - name: Create Pull Request
        if: steps.work-action.outputs.action == 'end' && steps.pr-config.outputs.skip_pr != 'true' && steps.pr-config.outputs.auto_create == 'true'
        id: create-pr
        run: |
          JIRA_TICKET="${{ steps.extract-ticket.outputs.jira_ticket }}"
          SOURCE_BRANCH="${{ steps.pr-config.outputs.source_branch }}"
          TARGET_BRANCH="${{ steps.pr-config.outputs.target_branch }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          DRAFT="${{ steps.pr-config.outputs.draft }}"

          echo "ðŸ”€ Pull Request ìƒì„± ì¤‘..."
          echo "  Source: ${SOURCE_BRANCH}"
          echo "  Target: ${TARGET_BRANCH}"

          # PR ì œëª© ìƒì„± (Issue ì œëª© ì‚¬ìš©)
          PR_TITLE="${ISSUE_TITLE}"

          # PR ë³¸ë¬¸ ìƒì„±
          PR_BODY="## ðŸ“‹ ìž‘ì—… ë‚´ìš©

          closes #${ISSUE_NUMBER}

          ### ðŸŽ« ê´€ë ¨ Jira í‹°ì¼“
          [${{ steps.extract-ticket.outputs.jira_ticket }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.extract-ticket.outputs.jira_ticket }})

          ### â±ï¸ ìž‘ì—… ì‹œê°„
          ${{ steps.end-work.outputs.work_time }}

          ### ðŸ‘¤ ìž‘ì—…ìž
          ${{ github.actor }}

          ---
          ì´ PRì€ work:end ë¼ë²¨ì— ì˜í•´ ìžë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."

          # Draft ì˜µì…˜ ì²˜ë¦¬
          DRAFT_FLAG=""
          if [ "$DRAFT" = "true" ]; then
            DRAFT_FLAG="--draft"
          fi

          # PR ìƒì„±
          PR_URL=$(gh pr create \
            --base "${TARGET_BRANCH}" \
            --head "${SOURCE_BRANCH}" \
            --title "${PR_TITLE}" \
            --body "${PR_BODY}" \
            ${DRAFT_FLAG})

          echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
          echo "âœ… Pull Request ìƒì„± ì™„ë£Œ"
          echo "ðŸ”— ${PR_URL}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 4-E. Issue ë‹«ê¸°
      - name: Close GitHub Issue
        if: steps.work-action.outputs.action == 'end' && steps.extract-ticket.outputs.skip != 'true'
        run: |
          PR_URL="${{ steps.create-pr.outputs.pr_url }}"

          echo "ðŸ”’ GitHub Issue ë‹«ëŠ” ì¤‘..."

          CLOSE_COMMENT="âœ… ìž‘ì—…ì´ ì™„ë£Œë˜ì–´ ìžë™ìœ¼ë¡œ Issueê°€ ë‹«í˜”ìŠµë‹ˆë‹¤."
          if [ -n "$PR_URL" ]; then
            CLOSE_COMMENT="${CLOSE_COMMENT}\n\nðŸ”€ Pull Request: ${PR_URL}"
          fi

          gh issue close ${{ github.event.issue.number }} --comment "${CLOSE_COMMENT}"

          echo "âœ… Issue ë‹«ê¸° ì™„ë£Œ - Jira ìƒíƒœëŠ” sync-issue-status ì›Œí¬í”Œë¡œìš°ì—ì„œ ìžë™ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 5. GitHub Issueì— ìž‘ì—… ë¡œê·¸ ì½”ë©˜íŠ¸
      - name: Comment work log on GitHub
        if: steps.extract-ticket.outputs.skip != 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## ${{ steps.work-action.outputs.action == 'start' && 'ðŸš€ ìž‘ì—… ì‹œìž‘' || 'âœ… ìž‘ì—… ì™„ë£Œ' }}

            | | |
            |:---|:---|
            | ðŸŽ« **Jira Ticket** | [${{ steps.extract-ticket.outputs.jira_ticket }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.extract-ticket.outputs.jira_ticket }}) |
            | ${{ steps.work-action.outputs.action == 'start' && 'â° **ì‹œìž‘ ì‹œê°„**' || 'â±ï¸ **ìž‘ì—… ì‹œê°„**' }} | ${{ steps.work-action.outputs.action == 'start' && steps.start-work.outputs.start_time || steps.end-work.outputs.work_time }} |
            | ðŸ‘¤ **ë‹´ë‹¹ìž** | @${{ github.actor }} |

            > Jira Work Logê°€ ìžë™ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.
            > Jira ìƒíƒœëŠ” sync-issue-status ì›Œí¬í”Œë¡œìš°ì—ì„œ ìžë™ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤.

      # 6. PR ìƒì„± ì™„ë£Œ ì½”ë©˜íŠ¸ (work:endì¼ ë•Œë§Œ)
      - name: Comment PR creation on GitHub
        if: steps.work-action.outputs.action == 'end' && steps.create-pr.outputs.pr_url != ''
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## ðŸ”€ Pull Request ìƒì„± ì™„ë£Œ

            ìžë™ìœ¼ë¡œ ìƒì„±ëœ Pull Request: ${{ steps.create-pr.outputs.pr_url }}

            > Target Branch: `${{ steps.pr-config.outputs.target_branch }}`
