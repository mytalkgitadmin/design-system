name: Jira Work Log Management

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      action:
        description: 'Work action (start or end)'
        required: true
        type: choice
        options:
          - start
          - end
      issue_number:
        description: 'GitHub Issue number'
        required: true
        type: string

jobs:
  manage-worklog:
    name: Manage Jira Work Log
    runs-on: ubuntu-latest
    # "work:start" ë˜ëŠ” "work:end" ë¼ë²¨ì´ ì¶”ê°€ë˜ê±°ë‚˜, íŠ¹ì • ì½”ë©˜íŠ¸ê°€ ë‹¬ë ¸ì„ ë•Œë§Œ ì‹¤í–‰
    if: |
      (github.event_name == 'issues' && (contains(github.event.label.name, 'work:start') || contains(github.event.label.name, 'work:end'))) ||
      (github.event_name == 'issue_comment' && (startsWith(github.event.comment.body, '/work-start') || startsWith(github.event.comment.body, '/work-end')))

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ (config íŒŒì¼ ì½ê¸° ìœ„í•¨)
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Jira í‹°ì¼“ ì¶”ì¶œ
      - name: Extract Jira ticket
        id: extract-ticket
        run: |
          # ì œëª©ì—ì„œ [JIRA-123] í˜•ì‹ìœ¼ë¡œ ì¶”ì¶œ
          JIRA_TICKET=$(echo '${{ github.event.issue.title }}' | grep -oE '\[([A-Z]+-[0-9]+)\]' | tr -d '[]' | head -n 1)
          
          # ì œëª©ì— ì—†ìœ¼ë©´ ë³¸ë¬¸ì—ì„œ ì¶”ì¶œ
          if [ -z "$JIRA_TICKET" ]; then
            JIRA_TICKET=$(echo '${{ github.event.issue.body }}' | grep -oE '([A-Z]+-[0-9]+)' | head -n 1)
          fi
          
          if [ -z "$JIRA_TICKET" ]; then
            echo "âš ï¸  Jira í‹°ì¼“ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "jira_ticket=$JIRA_TICKET" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "âœ… Jira í‹°ì¼“: $JIRA_TICKET"

      # 3. ì‘ì—… íƒ€ì… ê²°ì • (ì‹œì‘ or ì¢…ë£Œ)
      - name: Determine work action
        id: work-action
        run: |
          if [ "${{ github.event_name }}" = "issues" ]; then
            LABEL="${{ github.event.label.name }}"
            if [ "$LABEL" = "work:start" ]; then
              echo "action=start" >> $GITHUB_OUTPUT
            elif [ "$LABEL" = "work:end" ]; then
              echo "action=end" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT="${{ github.event.comment.body }}"
            if echo "$COMMENT" | grep -q "^/work-start"; then
              echo "action=start" >> $GITHUB_OUTPUT
            elif echo "$COMMENT" | grep -q "^/work-end"; then
              echo "action=end" >> $GITHUB_OUTPUT
            fi
          fi
          
          echo "âœ… ì‘ì—… íƒ€ì…: $(cat $GITHUB_OUTPUT | grep action | cut -d= -f2)"

      # 4-A. ì‘ì—… ì‹œì‘ - Jira ìƒíƒœë¥¼ "ì§„í–‰ ì¤‘"ìœ¼ë¡œ ë³€ê²½
      - name: Start work - Update Jira to "In Progress"
        if: steps.work-action.outputs.action == 'start' && steps.extract-ticket.outputs.skip != 'true'
        id: start-work
        run: |
          JIRA_TICKET="${{ steps.extract-ticket.outputs.jira_ticket }}"
          START_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.000+0000")
          
          echo "ğŸš€ ì‘ì—… ì‹œì‘ ì²˜ë¦¬ ì¤‘..."
          
          # 1. ì €ì¥ëœ workflow ì„¤ì • í™•ì¸
          CONFIG_FILE="scripts/jira/jira-workflow-config.json"
          
          if [ -f "$CONFIG_FILE" ]; then
            echo "ğŸ“„ ì €ì¥ëœ workflow ì„¤ì • ì‚¬ìš©"
            TRANSITION_ID=$(jq -r '.mappings.start' "$CONFIG_FILE")
            
            if [ "$TRANSITION_ID" != "null" ] && [ -n "$TRANSITION_ID" ]; then
              echo "âœ… ì„¤ì •ëœ Transition ID: $TRANSITION_ID"
            else
              echo "âš ï¸  ì„¤ì • íŒŒì¼ì— start transitionì´ ì—†ìŠµë‹ˆë‹¤. ìë™ íƒìƒ‰..."
              TRANSITION_ID=""
            fi
          else
            echo "âš ï¸  Workflow ì„¤ì • íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìë™ íƒìƒ‰..."
            TRANSITION_ID=""
          fi
          
          # 2. ì„¤ì •ì´ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ì°¾ê¸°
          if [ -z "$TRANSITION_ID" ] || [ "$TRANSITION_ID" = "null" ]; then
            echo "ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ transition ì¡°íšŒ ì¤‘..."
            TRANSITIONS=$(curl -s -X GET \
              -H "Content-Type: application/json" \
              -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/transitions")
            
            echo "ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ transition ëª©ë¡:"
            echo "$TRANSITIONS" | jq -r '.transitions[] | "  ID: \(.id) | \(.name) â†’ \(.to.name)"'
            
            TRANSITION_ID=$(echo "$TRANSITIONS" | jq -r '.transitions[] | select(
              (.to.name | ascii_downcase) == "in progress" or
              (.to.name | ascii_downcase) == "ì§„í–‰ ì¤‘" or
              (.to.name | ascii_downcase) == "ì§„í–‰ì¤‘" or
              (.to.name | ascii_downcase) == "ê°œë°œì¤‘" or
              (.to.name | ascii_downcase) == "ê°œë°œ ì¤‘" or
              (.name | ascii_downcase) == "in progress" or
              (.name | ascii_downcase) | contains("progress")
            ) | .id' | head -n 1)
          fi
          
          # 3. Transition ì‹¤í–‰ (ë‹¤ë‹¨ê³„ ì§€ì›)
          if [ -n "$TRANSITION_ID" ] && [ "$TRANSITION_ID" != "null" ]; then
            echo "ğŸ”„ Transition ì‹¤í–‰: ID=$TRANSITION_ID"
            
            # Config íŒŒì¼ì—ì„œ ëª©í‘œ ìƒíƒœ ì°¾ê¸°
            TARGET_STATUS=$(jq -r --arg id "$TRANSITION_ID" '.transitions[] | select(.id == $id) | .toStatus' "$CONFIG_FILE")
            echo "ğŸ¯ ëª©í‘œ ìƒíƒœ: $TARGET_STATUS"
            
            # ë‹¤ë‹¨ê³„ transition (ìµœëŒ€ 5ë²ˆ)
            for attempt in $(seq 1 5); do
              CURRENT_STATUS=$(curl -s -X GET \
                -H "Content-Type: application/json" \
                -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
                "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}" | jq -r '.fields.status.name')
              
              if [ "$CURRENT_STATUS" = "$TARGET_STATUS" ]; then
                echo "âœ… ëª©í‘œ ìƒíƒœ ë„ë‹¬: $TARGET_STATUS"
                break
              fi
              
              AVAIL_TRANSITIONS=$(curl -s -X GET \
                -H "Content-Type: application/json" \
                -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
                "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/transitions")
              
              NEXT_ID=$(echo "$AVAIL_TRANSITIONS" | jq -r --arg target "$TARGET_STATUS" '.transitions[] | select((.to.name | ascii_downcase) == ($target | ascii_downcase)) | .id' | head -n 1)
              
              if [ -z "$NEXT_ID" ] || [ "$NEXT_ID" = "null" ]; then
                NEXT_ID=$(echo "$AVAIL_TRANSITIONS" | jq -r '.transitions[0].id')
              fi
              
              if [ -z "$NEXT_ID" ] || [ "$NEXT_ID" = "null" ]; then
                break
              fi
              
              curl -s -X POST \
                -H "Content-Type: application/json" \
                -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
                -d "{\"transition\": {\"id\": \"${NEXT_ID}\"}}" \
                "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/transitions" > /dev/null
              
              sleep 1
            done
            
            echo "âœ… ìƒíƒœ ë³€ê²½ ì™„ë£Œ"
          else
            echo "âš ï¸  ì ì ˆí•œ transitionì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "ğŸ’¡ 'Setup Jira Workflow'ë¥¼ ì‹¤í–‰í•˜ì—¬ workflowë¥¼ ì„¤ì •í•˜ì„¸ìš”."
          fi
          
          # 2. Work Log ì¶”ê°€ (1ì´ˆë§Œ ê¸°ë¡)
          curl -X POST \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{
              \"comment\": \"ğŸš€ ì‘ì—… ì‹œì‘\\n\\nğŸ“Œ By: ${{ github.actor }}\\nğŸ”— GitHub Issue: ${{ github.event.issue.html_url }}\",
              \"started\": \"${START_TIME}\",
              \"timeSpentSeconds\": 1
            }" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/worklog"
          
          # 3. í˜„ì¬ ì‚¬ìš©ìë¥¼ ë‹´ë‹¹ìë¡œ ì„¤ì •
          MYSELF=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/myself")
          
          ACCOUNT_ID=$(echo "$MYSELF" | jq -r '.accountId')
          
          curl -X PUT \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{\"accountId\": \"${ACCOUNT_ID}\"}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/assignee"
          
          # 4. Start date ì„¤ì •
          START_DATE=$(date -u +"%Y-%m-%d")
          curl -X PUT \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{\"fields\": {\"customfield_10015\": \"${START_DATE}\"}}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}"
          
          echo "start_time=${START_TIME}" >> $GITHUB_OUTPUT
          echo "âœ… ì‘ì—… ì‹œì‘ ì™„ë£Œ"

      # 4-B. ì‘ì—… ì¢…ë£Œ - Work Log ê¸°ë¡ ë° ìƒíƒœë¥¼ "Done"ìœ¼ë¡œ ë³€ê²½
      - name: End work - Add work log and update to "Done"
        if: steps.work-action.outputs.action == 'end' && steps.extract-ticket.outputs.skip != 'true'
        id: end-work
        run: |
          JIRA_TICKET="${{ steps.extract-ticket.outputs.jira_ticket }}"
          END_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.000+0000")
          
          echo "âœ… ì‘ì—… ì¢…ë£Œ ì²˜ë¦¬ ì¤‘..."
          
          # 1. ì‘ì—… ì‹œê°„ ê³„ì‚° (GitHub Issue ìƒì„±/ë¼ë²¨ë§ ì‹œê°„ ê¸°ì¤€)
          # GitHub APIë¡œ "work:start" ë¼ë²¨ì´ ì¶”ê°€ëœ ì‹œê°„ ì¡°íšŒ
          EVENTS=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/events")
          
          START_TIME=$(echo "$EVENTS" | jq -r '.[] | select(.event == "labeled" and .label.name == "work:start") | .created_at' | head -n 1)
          
          if [ -z "$START_TIME" ] || [ "$START_TIME" = "null" ]; then
            echo "âš ï¸  ì‘ì—… ì‹œì‘ ì‹œê°„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’(1ì‹œê°„) ì‚¬ìš©"
            WORK_SECONDS=3600
            START_TIME=$(date -u -d '1 hour ago' +"%Y-%m-%dT%H:%M:%S.000+0000" 2>/dev/null || date -u -v-1H +"%Y-%m-%dT%H:%M:%S.000+0000")
          else
            # ì‘ì—… ì‹œê°„ ê³„ì‚° (ì´ˆ ë‹¨ìœ„)
            START_EPOCH=$(date -d "$START_TIME" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$START_TIME" +%s)
            END_EPOCH=$(date +%s)
            WORK_SECONDS=$((END_EPOCH - START_EPOCH))
            
            # ìµœì†Œ 60ì´ˆ ë³´ì¥
            if [ $WORK_SECONDS -lt 60 ]; then
              WORK_SECONDS=60
            fi
          fi
          
          WORK_HOURS=$((WORK_SECONDS / 3600))
          WORK_MINUTES=$(((WORK_SECONDS % 3600) / 60))
          
          echo "â±ï¸  ì‘ì—… ì‹œê°„: ${WORK_HOURS}ì‹œê°„ ${WORK_MINUTES}ë¶„ (${WORK_SECONDS}ì´ˆ)"
          
          # 2. Work Log ì¶”ê°€
          curl -X POST \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{
              \"comment\": \"âœ… ì‘ì—… ì™„ë£Œ\\n\\nâ±ï¸  ì‘ì—… ì‹œê°„: ${WORK_HOURS}ì‹œê°„ ${WORK_MINUTES}ë¶„\\nğŸ“Œ By: ${{ github.actor }}\\nğŸ”— GitHub Issue: ${{ github.event.issue.html_url }}\",
              \"started\": \"${START_TIME}\",
              \"timeSpentSeconds\": ${WORK_SECONDS}
            }" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/worklog"
          
          echo "âœ… Work Log ì¶”ê°€ ì™„ë£Œ"
          
          # 3. ìƒíƒœë¥¼ "Done"ìœ¼ë¡œ ë³€ê²½
          CONFIG_FILE="scripts/jira/jira-workflow-config.json"
          
          if [ -f "$CONFIG_FILE" ]; then
            echo "ğŸ“„ ì €ì¥ëœ workflow ì„¤ì • ì‚¬ìš©"
            TRANSITION_ID=$(jq -r '.mappings.end' "$CONFIG_FILE")
            
            if [ "$TRANSITION_ID" != "null" ] && [ -n "$TRANSITION_ID" ]; then
              echo "âœ… ì„¤ì •ëœ Transition ID: $TRANSITION_ID"
            else
              echo "âš ï¸  ì„¤ì • íŒŒì¼ì— end transitionì´ ì—†ìŠµë‹ˆë‹¤. ìë™ íƒìƒ‰..."
              TRANSITION_ID=""
            fi
          else
            echo "âš ï¸  Workflow ì„¤ì • íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìë™ íƒìƒ‰..."
            TRANSITION_ID=""
          fi
          
          # ì„¤ì •ì´ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ì°¾ê¸°
          if [ -z "$TRANSITION_ID" ] || [ "$TRANSITION_ID" = "null" ]; then
            echo "ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ transition ì¡°íšŒ ì¤‘..."
            TRANSITIONS=$(curl -s -X GET \
              -H "Content-Type: application/json" \
              -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/transitions")
            
            echo "ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ transition ëª©ë¡:"
            echo "$TRANSITIONS" | jq -r '.transitions[] | "  ID: \(.id) | \(.name) â†’ \(.to.name)"'
            
            TRANSITION_ID=$(echo "$TRANSITIONS" | jq -r '.transitions[] | select(
              (.to.name | ascii_downcase) == "done" or
              (.to.name | ascii_downcase) == "ì™„ë£Œ" or
              (.to.name | ascii_downcase) == "í•´ê²°ë¨" or
              (.to.name | ascii_downcase) == "ì¢…ë£Œ" or
              (.to.name | ascii_downcase) == "closed" or
              (.name | ascii_downcase) == "done" or
              (.name | ascii_downcase) | contains("done")
            ) | .id' | head -n 1)
          fi
          
          # Transition ì‹¤í–‰ (ë‹¤ë‹¨ê³„ ì§€ì›)
          if [ -n "$TRANSITION_ID" ] && [ "$TRANSITION_ID" != "null" ]; then
            echo "ğŸ”„ Transition ì‹¤í–‰: ID=$TRANSITION_ID"
            
            # Config íŒŒì¼ì—ì„œ ëª©í‘œ ìƒíƒœ ì°¾ê¸°
            TARGET_STATUS=$(jq -r --arg id "$TRANSITION_ID" '.transitions[] | select(.id == $id) | .toStatus' "$CONFIG_FILE")
            echo "ğŸ¯ ëª©í‘œ ìƒíƒœ: $TARGET_STATUS"
            
            # ë‹¤ë‹¨ê³„ transition (ìµœëŒ€ 5ë²ˆ)
            for attempt in $(seq 1 5); do
              CURRENT_STATUS=$(curl -s -X GET \
                -H "Content-Type: application/json" \
                -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
                "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}" | jq -r '.fields.status.name')
              
              if [ "$CURRENT_STATUS" = "$TARGET_STATUS" ]; then
                echo "âœ… ëª©í‘œ ìƒíƒœ ë„ë‹¬: $TARGET_STATUS"
                break
              fi
              
              AVAIL_TRANSITIONS=$(curl -s -X GET \
                -H "Content-Type: application/json" \
                -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
                "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/transitions")
              
              NEXT_ID=$(echo "$AVAIL_TRANSITIONS" | jq -r --arg target "$TARGET_STATUS" '.transitions[] | select((.to.name | ascii_downcase) == ($target | ascii_downcase)) | .id' | head -n 1)
              
              if [ -z "$NEXT_ID" ] || [ "$NEXT_ID" = "null" ]; then
                NEXT_ID=$(echo "$AVAIL_TRANSITIONS" | jq -r '.transitions[0].id')
              fi
              
              if [ -z "$NEXT_ID" ] || [ "$NEXT_ID" = "null" ]; then
                break
              fi
              
              curl -s -X POST \
                -H "Content-Type: application/json" \
                -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
                -d "{\"transition\": {\"id\": \"${NEXT_ID}\"}}" \
                "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/transitions" > /dev/null
              
              sleep 1
            done
            
            echo "âœ… ìƒíƒœ ë³€ê²½ ì™„ë£Œ"
          else
            echo "âš ï¸  ì ì ˆí•œ transitionì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "ğŸ’¡ 'Setup Jira Workflow'ë¥¼ ì‹¤í–‰í•˜ì—¬ workflowë¥¼ ì„¤ì •í•˜ì„¸ìš”."
          fi
          
          echo "work_time=${WORK_HOURS}ì‹œê°„ ${WORK_MINUTES}ë¶„" >> $GITHUB_OUTPUT

      # 5. GitHub Issueì— ê²°ê³¼ ì½”ë©˜íŠ¸
      - name: Comment result on GitHub
        if: steps.extract-ticket.outputs.skip != 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## ${{ steps.work-action.outputs.action == 'start' && 'ğŸš€ ì‘ì—… ì‹œì‘ë¨' || 'âœ… ì‘ì—… ì™„ë£Œë¨' }}
            
            **Jira Ticket:** [${{ steps.extract-ticket.outputs.jira_ticket }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.extract-ticket.outputs.jira_ticket }})
            ${{ steps.work-action.outputs.action == 'start' && format('**ì‹œì‘ ì‹œê°„:** {0}', steps.start-work.outputs.start_time) || format('**ì‘ì—… ì‹œê°„:** {0}', steps.end-work.outputs.work_time) }}
            **ë‹´ë‹¹ì:** @${{ github.actor }}
            
            _Jira Work Logê°€ ìë™ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤._

