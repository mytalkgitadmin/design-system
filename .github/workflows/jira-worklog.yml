name: Jira Work Log Management

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      action:
        description: "Work action (start or end)"
        required: true
        type: choice
        options:
          - start
          - end
      issue_number:
        description: "GitHub Issue number"
        required: true
        type: string

jobs:
  manage-worklog:
    name: Manage Jira Work Log
    runs-on: ubuntu-latest
    # "work:start" 또는 "work:end" 라벨이 추가되거나, 특정 코멘트가 달렸을 때만 실행
    if: |
      (github.event_name == 'issues' && (contains(github.event.label.name, 'work:start') || contains(github.event.label.name, 'work:end'))) ||
      (github.event_name == 'issue_comment' && (startsWith(github.event.comment.body, '/work-start') || startsWith(github.event.comment.body, '/work-end')))

    steps:
      # 1. 코드 체크아웃 (config 파일 읽기 위함)
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Jira 티켓 추출
      - name: Extract Jira ticket
        id: extract-ticket
        run: |
          # 제목에서 [JIRA-123] 형식으로 추출
          JIRA_TICKET=$(echo '${{ github.event.issue.title }}' | grep -oE '\[([A-Z]+-[0-9]+)\]' | tr -d '[]' | head -n 1)

          # 제목에 없으면 본문에서 추출
          if [ -z "$JIRA_TICKET" ]; then
            JIRA_TICKET=$(echo '${{ github.event.issue.body }}' | grep -oE '([A-Z]+-[0-9]+)' | head -n 1)
          fi

          if [ -z "$JIRA_TICKET" ]; then
            echo "⚠️  Jira 티켓을 찾을 수 없습니다."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "jira_ticket=$JIRA_TICKET" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "✅ Jira 티켓: $JIRA_TICKET"

      # 3. 작업 타입 결정 (시작 or 종료)
      - name: Determine work action
        id: work-action
        run: |
          if [ "${{ github.event_name }}" = "issues" ]; then
            LABEL="${{ github.event.label.name }}"
            if [ "$LABEL" = "work:start" ]; then
              echo "action=start" >> $GITHUB_OUTPUT
            elif [ "$LABEL" = "work:end" ]; then
              echo "action=end" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT="${{ github.event.comment.body }}"
            if echo "$COMMENT" | grep -q "^/work-start"; then
              echo "action=start" >> $GITHUB_OUTPUT
            elif echo "$COMMENT" | grep -q "^/work-end"; then
              echo "action=end" >> $GITHUB_OUTPUT
            fi
          fi

          echo "✅ 작업 타입: $(cat $GITHUB_OUTPUT | grep action | cut -d= -f2)"

      # 4-A. 작업 시작 - Work Log 기록
      - name: Start work - Add work log
        if: steps.work-action.outputs.action == 'start' && steps.extract-ticket.outputs.skip != 'true'
        id: start-work
        run: |
          JIRA_TICKET="${{ steps.extract-ticket.outputs.jira_ticket }}"
          START_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.000+0000")

          echo "🚀 작업 시작 처리 중..."

          # Work Log 추가 (1초만 기록)
          echo "📝 Work Log 기록 중..."
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{
              \"comment\": \"🚀 작업 시작\\n\\n📌 By: ${{ github.actor }}\\n🔗 GitHub Issue: ${{ github.event.issue.html_url }}\",
              \"started\": \"${START_TIME}\",
              \"timeSpentSeconds\": 1
            }" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/worklog" > /dev/null

          echo "✅ Work Log 기록 완료"

          # Start date 설정
          echo ""
          echo "📅 Start date 설정 중..."
          START_DATE=$(date -u +"%Y-%m-%d")
          curl -s -X PUT \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{\"fields\": {\"customfield_10015\": \"${START_DATE}\"}}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}" > /dev/null

          echo "✅ Start date 설정 완료"
          echo ""
          echo "start_time=${START_TIME}" >> $GITHUB_OUTPUT
          echo "🎉 작업 시작 완료!"

      # 4-B. 작업 종료 - Work Log 기록
      - name: End work - Add work log
        if: steps.work-action.outputs.action == 'end' && steps.extract-ticket.outputs.skip != 'true'
        id: end-work
        run: |
          JIRA_TICKET="${{ steps.extract-ticket.outputs.jira_ticket }}"
          END_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.000+0000")

          echo "✅ 작업 종료 처리 중..."

          # 1. 작업 시간 계산 (GitHub Issue 생성/라벨링 시간 기준)
          # GitHub API로 "work:start" 라벨이 추가된 시간 조회
          EVENTS=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/events")

          START_TIME_RAW=$(echo "$EVENTS" | jq -r '.[] | select(.event == "labeled" and .label.name == "work:start") | .created_at' | head -n 1)

          if [ -z "$START_TIME_RAW" ] || [ "$START_TIME_RAW" = "null" ]; then
            echo "⚠️  작업 시작 시간을 찾을 수 없습니다. 기본값(1시간) 사용"
            WORK_SECONDS=3600
            # Linux에서 실행되므로 -d 옵션 사용
            START_TIME=$(date -u -d '1 hour ago' +"%Y-%m-%dT%H:%M:%S.000+0000")
          else
            # GitHub Actions는 Linux에서 실행 (Ubuntu)
            START_EPOCH=$(date -d "$START_TIME_RAW" +%s)
            END_EPOCH=$(date +%s)
            WORK_SECONDS=$((END_EPOCH - START_EPOCH))
            
            # 최소 60초 보장
            if [ $WORK_SECONDS -lt 60 ]; then
              WORK_SECONDS=60
            fi
            
            # GitHub ISO 8601 형식을 Jira 형식으로 변환 (2025-12-17T04:17:44Z → 2025-12-17T04:17:44.000+0000)
            START_TIME=$(date -u -d "$START_TIME_RAW" +"%Y-%m-%dT%H:%M:%S.000+0000")
          fi

          WORK_HOURS=$((WORK_SECONDS / 3600))
          WORK_MINUTES=$(((WORK_SECONDS % 3600) / 60))

          echo "⏱️  작업 시간: ${WORK_HOURS}시간 ${WORK_MINUTES}분 (${WORK_SECONDS}초)"

          # 2. Work Log 추가
          echo "📝 Work Log 요청 데이터:"
          echo "  - Started: ${START_TIME}"
          echo "  - Time Spent: ${WORK_SECONDS}초 (${WORK_HOURS}h ${WORK_MINUTES}m)"

          WORKLOG_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{
              \"comment\": \"✅ 작업 완료\\n\\n⏱️  작업 시간: ${WORK_HOURS}시간 ${WORK_MINUTES}분\\n📌 By: ${{ github.actor }}\\n🔗 GitHub Issue: ${{ github.event.issue.html_url }}\",
              \"started\": \"${START_TIME}\",
              \"timeSpentSeconds\": ${WORK_SECONDS}
            }" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue/${JIRA_TICKET}/worklog")

          HTTP_CODE=$(echo "$WORKLOG_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$WORKLOG_RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Work Log 추가 완료 (HTTP $HTTP_CODE)"
          else
            echo "❌ Work Log 추가 실패 (HTTP $HTTP_CODE)"
            echo "응답: $RESPONSE_BODY"
          fi

          echo "work_time=${WORK_HOURS}시간 ${WORK_MINUTES}분" >> $GITHUB_OUTPUT

      # 5. GitHub Issue에 작업 로그 코멘트
      - name: Comment work log on GitHub
        if: steps.extract-ticket.outputs.skip != 'true'
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## ${{ steps.work-action.outputs.action == 'start' && '🚀 작업 시작' || '✅ 작업 완료' }}

            | | |
            |:---|:---|
            | 🎫 **Jira Ticket** | [${{ steps.extract-ticket.outputs.jira_ticket }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.extract-ticket.outputs.jira_ticket }}) |
            | ${{ steps.work-action.outputs.action == 'start' && '⏰ **시작 시간**' || '⏱️ **작업 시간**' }} | ${{ steps.work-action.outputs.action == 'start' && steps.start-work.outputs.start_time || steps.end-work.outputs.work_time }} |
            | 👤 **담당자** | @${{ github.actor }} |

            > Jira Work Log가 자동으로 기록되었습니다.
            > Jira 상태는 sync-issue-status 워크플로우에서 자동으로 동기화됩니다.
